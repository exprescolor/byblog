---
layout:     post 
title:      SpringBoot项目问题
subtitle:   网上商城
date:       2019-11-14
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 错误解决
---

#### 网上商城项目进行了将近20天，每天都在打代码，现在基本已经完成，剩下的功能两天就能完成。但是没有进行总结，为了防止以后遇到同样的问题不知道怎么处理，故花一些时间进行一下总结。总的来说项目本身不难，只是一些小功能让人很头疼，例如购物车，以及前端框架问题。本文档仅记录目前为止本人遇到的问题，一些基础知识或者无关紧要的问题不再显示。所有知识仅供参考，毕竟代码在别人领进门之后，剩下的都是靠自己摸索才能真正学会的。

----------------------------------------------

#### 1.pom依赖

- 因为现在的项目足够稳定，故保存现在的pom依赖。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.0.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.sc</groupId>
    <artifactId>market</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>market</name>
    <description>Demo project for Spring Boot</description>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.1.1</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.5</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
            <version>5.1.41</version>
        </dependency>
        <dependency>
            <groupId>com.github.theborakompanioni</groupId>
            <artifactId>thymeleaf-extras-shiro</artifactId>
            <version>2.0.0</version>
        </dependency>
        <dependency>
            <groupId>org.apache.shiro</groupId>
            <artifactId>shiro-spring</artifactId>
            <version>1.3.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.junit.vintage</groupId>
                    <artifactId>junit-vintage-engine</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>org.apache.shiro</groupId>
            <artifactId>shiro-core</artifactId>
            <version>1.4.1</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

#### 2.application.yml配置文件（包括Mybatis）

```xml
spring:
  datasource:
    url: jdbc:mysql:///market?useUnicode=true&characterEncoding=utf8&useSSL=false
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: root

server:
  port: 8080

mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.sc.entity
```

#### 3.Thymeleaf声明连接

```html
xmlns:th="http://www.thymeleaf.org"
```

#### 4.购物车功能

- 1.商品数量加减按钮实现商品数量增加或减少

```javascript
<script >
        //按下+按钮
        function add(){
            //取出当前页面的数量
            var num=document.getElementById("text").value;
            //将数量加一然后再赋值给显示数量的<inpue>中的value属性
            ++num;
            document.getElementById("text").value=num;
        }
        //按下-按钮
        function minus(){
            var num=document.getElementById("text").value;
            //判断数量是不是负数
            if(--num<1){
                document.getElementById("text").value=0;
            }else{
                document.getElementById("text").value=num
            }
            //取出当前页面的数量，与数量相乘，赋值给小计所属的div的页面显示内容
            //给num重新赋值是放置出现num=-1情况
        }
    </script>
```

- 2.添加商品到购物车中

```javascript
function saveToCart(productid) {
        var productnum1=document.getElementById("text").value;
        var productnum=productnum1;
        var userid1=document.getElementById("userid").value;
        console.log(userid1);
        var userid=userid1;
        var data={
            "productid":productid,
            "productnum":productnum,
            "userid":userid
        };
        $.ajax({
            type:'POST',
            url:'/shop-cart',
            contentType:'application/json',
            data:JSON.stringify(data),
            success:function () {
                if (200){
                    alert("添加成功");
                    window.location.reload();
                }else {
                    alert("添加失败");
                }
            },
            error:function () {
                alert("操作失败");
            }
        });
    }
```

```java
 @RequestMapping("/shop-cart")
    @ResponseBody
    public int saveToCart(@RequestBody Minicart minicart, Map map, HttpSession httpSession){
        minicartService.addMinicart(minicart);
        return 200;
    }
```

- 3.点击x删除购物车中的商品

```javascript
function deleteItem(minicartid) {
        $.ajax({
            type:'DELETE',
            url:'/shop-cart/' + minicartid,
            success:function () {
                if (300) {
                    alert("删除成功!");
                    window.location.reload();
                }
            }
        });
    }
```

```java
@RequestMapping("/shop-cart/{minicartid}")
    @ResponseBody
    public int deleteItem(@PathVariable("minicartid") int minicartid){
        minicartService.deleteMinicartById(minicartid);
        return 300;
    }
```

#### 5.关联的两张表，Controller层遍历查询出来的列表来在前端展示关联表的信息

```java
List<Minicart> minicarts = minicartService.getMinicartByUserId(userid);
        //for循环遍历购物车列表
        for (Minicart minicart:minicarts){
            //得到购物车中每个商品的产品id
            int productid1 = minicart.getProductid();
            //得到购物车中每个商品的卖家用户id
            int userid1 = minicart.getUserid();
            //根据产品id查看产品信息
            Product product1 = productService.getProductById(productid1);
            //根据卖家id查看卖家信息
            User user1 = userService.getUserByUserId(userid1);
            //设置购物车中的卖家信息
            minicart.setUser(user1);
            //设置购物车中的产品信息
            minicart.setProduct(product1);
        }
```

- 数据库结构如下
```mysql
  create table minicart(
    minicartid int not null auto_increment primary key comment '主键购物车ID',
    productid int not null comment '商品ID',
    userid int not null comment '用户ID',
    productnum int not null comment '商品数量'
  )engine =InnoDB auto_increment=200 default charset =utf8;
  
  alter table minicart add foreign key (productid) references product(productid);
  
  alter table minicart add foreign key (userid) references user(userid);
```

#### 6.访问量功能

```java
public static Long Get_Visit_Count(String txtFilePath) {

        try {
            //读取文件(字符流)
            BufferedReader in = new BufferedReader(new InputStreamReader(new FileInputStream(txtFilePath),"UTF-8"));
            //循环读取数据
            String str = null;
            StringBuffer content = new StringBuffer();
            while ((str = in.readLine()) != null) {
                content.append(str);
            }
            //关闭流
            in.close();

            //System.out.println(content);
            // 解析获取的数据
            Long count = Long.valueOf(content.toString());
            count ++; // 访问量加1
            //写入相应的文件
            BufferedWriter out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(txtFilePath),"UTF-8"));
            out.write(String.valueOf(count));

            //清楚缓存
            out.flush();
            //关闭流
            out.close();

            return count;
        }
        catch (Exception e){
            e.printStackTrace();
            return 0L;
        }
    }
```

```java
String txtFilePath = "D://count.txt";
Long count = Get_Visit_Count(txtFilePath);
map.put("count", count); // 后台参数传递给前端
```

#### 7.Thymeleaf中的js中"window.location.href"的格式问题

```javascript
<script th:if="${alert!=null}" th:inline="javascript">
        var message=[[${alert}]];
        alert(message);
        window.location.href=[[@{/user_update_info/{roleid}/{userid}(userid=${userid},roleid=${roleid})}]];
    </script>
```

#### 8.Springboot项目的Mapper层需要注意的配置

- 每一个Mapper层需要在最上面加上@Mapper注解
- 启动类上需要加上`@MapperScan(value = "com.sc.mapper")`注解

#### 9.目前为止配置的Shiro拦截，以后基本按照这个结构来写，所以进行备份

```java
package com.sc.config;

import com.sc.shiro.CustomRealm;
import org.apache.shiro.mgt.DefaultSecurityManager;
import org.apache.shiro.mgt.SecurityManager;
import org.apache.shiro.spring.web.ShiroFilterFactoryBean;
import org.apache.shiro.web.mgt.DefaultWebSecurityManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.LinkedHashMap;
import java.util.Map;

@Configuration
public class ShiroConfig {

    /*
    配置Shiro的web过滤器，拦截浏览器请求并交给SecurityManager处理
     */
    @Bean
    public ShiroFilterFactoryBean webFilter(){
        ShiroFilterFactoryBean filterFactoryBean = new ShiroFilterFactoryBean();
        filterFactoryBean.setSecurityManager(securityManager());

        //配置拦截链，使用LinkedHashMap，因为LinkedHashMap是有序的，Shiro会根据添加的顺序进行拦截
        //Map<K,V>：K指的是拦截的URL，V指的是该URL是否拦截
        Map<String,String> filterChainMap = new LinkedHashMap<>(16);

        filterChainMap.put("/statics/**","anon");
        filterChainMap.put("/market","anon");
        filterChainMap.put("/admin/**","anon");
        filterChainMap.put("/index_easy_product_search","anon");
        filterChainMap.put("/to_register","anon");
        filterChainMap.put("/index_filter_price","anon");
        filterChainMap.put("/index_products","anon");
        filterChainMap.put("/index_product_detail/**","anon");
        filterChainMap.put("/index_to_category_product/**","anon");
        filterChainMap.put("/to_admin","anon");
        filterChainMap.put("/register","anon");
        filterChainMap.put("/logout","logout");
        filterChainMap.put("/login","anon");
        filterChainMap.put("/to_login","anon");
        filterChainMap.put("/**","authc");

        //设置拦截请求后跳转的URL
        filterFactoryBean.setLoginUrl("/market");
        filterFactoryBean.setFilterChainDefinitionMap(filterChainMap);
        return  filterFactoryBean;
    }

    @Bean
    public SecurityManager securityManager(){
        DefaultSecurityManager securityManager = new DefaultWebSecurityManager();
        securityManager.setRealm(customRealm());
        return securityManager;
    }

    @Bean
    public CustomRealm customRealm(){
        return new CustomRealm();
    }
}
```

```java
package com.sc.shiro;

import com.sc.entity.User;
import com.sc.service.UserService;
import org.apache.shiro.authc.*;
import org.apache.shiro.authz.AuthorizationInfo;
import org.apache.shiro.realm.AuthorizingRealm;
import org.apache.shiro.subject.PrincipalCollection;
import org.springframework.beans.factory.annotation.Autowired;

public class CustomRealm extends AuthorizingRealm {

    @Autowired
    private UserService userService;

    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principal) {
       return null;
    }

    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
        //获取输入的账号
        String username = (String) token.getPrincipal();
        //通过username从数据库中查到user实体
        User user = userService.getUserByUserName(username);
        if (user==null){
            throw new UnknownAccountException();
        }
        //通过SimpleAuthenticationInfo做身份处理
        SimpleAuthenticationInfo simpleAuthenticationInfo = new SimpleAuthenticationInfo(user, user.getPassword(), getName());
        //返回身份处理对象
        return simpleAuthenticationInfo;
    }
}
```