---
layout:     post 
title:      区块链
subtitle:   比特币网络、挖矿难度调整
date:       2019-12-07
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 区块链
---

#### 比特币网络的工作原理

- 比特币网络的底层是P2P网络
- 比特币网络中的所有结点都是平等的，如果你想加入这个网络，那么你就需要知道至少一个种子结点（seed node），种子结点会告诉你他所知道的这个网络中的其他结点。
- 结点之间是通过TCP来通讯的，这样有利于穿透防火墙。离开的时候不需要通知其他结点，只需要退出你的应用程序即可，别的节点没有收到你的消息，过了一段时间之后就会把你给删掉
- 比特币网络的设计原则是简单、鲁棒，而不是高效（simple,robust,but bot efficient）。消息传播在结点中采用flooding的方式，结点第一次听到某个消息的时候，把他传播给其他所有的邻居结点，同时记录下这个消息已经收到过了；下次再收到这个消息的时候，就不需要再转发给邻居结点了，邻居结点的选取是随机的，没有考虑底层的拓扑结构。比如一个在加利福尼亚的结点，他选的邻居节点，他选的邻居节点可能就是在阿根廷的。这样做的好处是增强鲁棒性，但是牺牲的是效率（你向身边的人转账，和向美国的人转账速度是差不多的）
- 比特币系统中每个结点都要维护一个等待上链的交易的集合
- 比特币网络的传播是属于best effort。一个交易发布到比特币网络上，不一定所有的结点都能收到，而且不同的节点收到同一消息的顺序也不一定是一样的。网络传播存在延迟，而且这个延迟有时候可能会很长，而且有的节点可能不按照比特币协议的要求进行转发

#### 比特币的挖矿难度调整

- **挖矿就是不断的尝试block header中的nonce值，使整个block header的哈希值小于等于给出的目标域值（H(block header<=target)）。target越小，挖矿难度是越大的。调整挖矿难度就是调整目标空间在整个输出空间所占的比例**
- 比特币用的哈希算法是SHA-256，这个算法产生的值是256位的，所以整个输出空间的大小是2的256次方
- 挖矿难度和目标域值是成反比的{diffictlty=(difficulty_1_target)/target——其中difficulty_1_target表示的是挖矿难度等于1的时候所对应的目标域值}。挖矿难度最小就是1，这时候对应的目标域值是一个非常大的数
- **出块时间太短会有什么问题？**
   - 出块时间太快，就会导致产生过多的分叉，因为会出现多个结点同时挖到矿的情况。分叉如果过多的话，对于系统达成共识，是没有好处的，而且也危害到系统的安全。**比特币协议是假设大部分算力是掌握在诚实的矿工手里，系统当中的总算力越强，安全性就越好，要发动51%攻击需要的算力就越大**

#### 具体怎么调整挖矿难度

- 比特币中规定每隔2016个区块就要重新调整一下目标域值，大概是每两个星期调整一下。调整的公式为`target=target*(actual time/expected time)`:acutal time指的是系统中最近产生的2016个区块实际花费的时间；expected time指的是2016乘10。在实际的操作中有四倍的限制，例如实际花费的时间非常长，超过了8个星期，那么我们在计算的时候也只按照8个星期来计算，所以目标域值不会一次性超过四倍；同理，当实际时间非常短，不到二分之一星期，那么我们计算的时候也按照二分之一来算，所以目标一致最小也不会降低四倍

![Qqdk9A.png](https://s2.ax1x.com/2019/12/19/Qqdk9A.png)

- 上图这个公式和上面所说的目标域值相同，都是正确的，只不过这个图片所示的是挖矿难度，而上面我写的是目标域值，目标域值和挖矿难度成反比，所以图片中是用2个星期除以实际时间。实际比特币代码中用的是目标域值。

 