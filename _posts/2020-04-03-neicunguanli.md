---
layout:     post   				    # 使用的布局（不需要改）
title:      第五章内存管理		# 标题 
#subtitle:   脚本，xss #副标题
date:       2020-04-03 				# 时间
author:     s-seven 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 6828
---

# 第五章 内存管理

80386通过两个步骤将逻辑地址（即，程序员所查看的地址）转换为物理地址（即，物理内存中的实际地址）：

- 段转换，其中将逻辑地址（由段选择器和段偏移量组成）转换为线性地址。
- 页面转换，其中线性地址转换为物理地址。该步骤是可选的，由系统软件设计人员决定。

这些翻译是以应用程序程序员不可见的方式执行的。如图：

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-1.gif)

## 5.1段转换

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-2.gif)

上图显示了处理器如何将逻辑地址转换为线性地址。

为了执行此转换，处理器使用以下数据结构：

- 描述符
- 描述符表
- 选择器
- 段寄存器

### 5.1描述符

段描述符为处理器提供了将逻辑地址映射为线性地址所需的数据。描述符是由编译器，链接器，加载器或操作系统创建的，而不是由应用程序程序员创建的。 如图是两种通用描述符格式。所有类型的段描述符都采用以下格式之一。

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-3.gif)

段描述符字段是：

BASE：定义段在4 GB线性地址空间内的位置。处理器将基地址的三个片段连接起来以形成单个32位值。

LIMIT：定义段的大小。当处理器将限制字段的两个部分串联时，将得到20位的值。处理器根据粒度位的设置以两种方式之一解释极限字段：

1. 以1字节为单位，以定义最大1 MB的限制。
2. 以4 KB为单位，以定义最大4 GB的限制。加载时，该限制向左移动12位，并插入低位一位。

粒度位：指定用于解释LIMIT字段的单位。当清除该位时，限制以一个字节为单位进行解释；设置后，限制将以4千字节为单位进行解释。

TYPE：区分各种描述符。

DPL（描述符特权级别）：由保护机制使用。

Segment-Present位：如果该位为零，则描述符在地址转换中无效。当描述符的选择器加载到段寄存器中时，处理器将发出异常信号。 操作系统可以自由使用标记为“可用”的位置。在以下两种情况之一中，实现基于段的虚拟内存的操作系统都会清除当前位：

- 当段所跨越的线性空间未被分页机制映射时。
- 当段不存在于内存中时。

访问位：访问段时，处理器将其设置为该位。即，用于描述符的选择器被加载到段寄存器中或由选择器测试指令使用。在网段级别实现虚拟内存的操作系统可以通过定期测试和清除该位来监控网段使用的频率。

描述符的创建和维护是系统软件的责任，通常需要编译器，程序加载器或系统构建器以及评估系统的配合。

### 5.1.2描述符表

段描述符存储在两种描述符表之一中：

- 全局描述符表（GDT）

- 本地描述符表（LDT）

描述符表只是包含描述符的8字节条目的存储阵列，如下图。描述符表的长度是可变的，最多可以包含8192（2 ^（13））个描述符。但是，处理器不使用GDT的第一个条目（INDEX = 0）。

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-5.gif)

处理器通过GDTR和LDTR寄存器在内存中定位GDT和当前LDT。这些寄存器将表的基地址存储在线性地址空间中，并存储段限制。LGDT和 SGDT指令可访问GDTR；指令 LLDT 和SLDT可以访问LDTR。

### 5.1.3选择器

逻辑地址的选择器部分通过指定描述符表并在该表中建立索引来标识描述符。选择器对于应用程序可能是指针变量中的字段可见的，但是选择器的值通常由链接器或链接加载器分配（固定）。 下图 显示了选择器的格式。

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-6.gif)

索引：在描述符表中选择8192个描述符之一。处理器只需将该索引值乘以8（描述符的长度），然后将结果添加到描述符表的基地址中，即可访问表中的适当段描述符。

表指示符：指定选择器引用哪个描述符表。零表示GDT；一个表示当前的LDT。

请求的特权级别：由保护机制使用。

因为处理器不使用GDT的第一个条目，所以索引为零且表指示符为零的选择器（即指向GDT的第一个条目的选择器）可以用作空值。选择器。当段寄存器（CS或SS除外）加载了空选择器时，处理器不会引起异常。但是，当段寄存器用于访问内存时，它将导致异常。此功能对于初始化未使用的段寄存器很有用，以捕获意外引用。

### 5.1.4段寄存器

80386将来自描述符的信息存储在段寄存器中，从而避免了每次访问存储器时都需要查阅描述符表的情况。

每个段寄存器都有一个“可见”部分和一个“不可见”部分。这些段地址寄存器的可见部分由程序操纵，就好像它们只是16位寄存器一样。不可见部分由处理器操纵。

加载这些寄存器的操作是常规程序指令。这些说明分为两类：

1. 直接加载指令；例如[MOV](https://pdos.csail.mit.edu/6.828/2018/readings/i386/MOV.htm)， [POP](https://pdos.csail.mit.edu/6.828/2018/readings/i386/POP.htm)， [LDS](https://pdos.csail.mit.edu/6.828/2018/readings/i386/LGS.htm)， [LSS](https://pdos.csail.mit.edu/6.828/2018/readings/i386/LGS.htm)， [LGS](https://pdos.csail.mit.edu/6.828/2018/readings/i386/LGS.htm)， [LFS](https://pdos.csail.mit.edu/6.828/2018/readings/i386/LGS.htm)。这些指令明确引用了段寄存器。
2. 默示的负载指令；例如，far [CALL](https://pdos.csail.mit.edu/6.828/2018/readings/i386/CALL.htm)和[JMP](https://pdos.csail.mit.edu/6.828/2018/readings/i386/JMP.htm)。这些指令隐式引用了CS寄存器，并为其加载了新值。

使用这些指令，程序将使用16位选择器加载段寄存器的可见部分。处理器自动从描述符表中获取基地址，限制，类型和其他信息，并将其加载到段寄存器的不可见部分。

因为大多数指令都引用其选择器已加载到段寄存器中的段中的数据，所以处理器可以将指令提供的段相对偏移量添加到段基地址，而不会产生额外开销。

## 5.2页面转换

在地址转换的第二阶段，80386将线性地址转换为物理地址。地址转换的这一阶段实现了面向页面的虚拟内存系统和页面级保护所需的基本功能。

页面翻译步骤是可选的。仅当CR0的PG位置1时，页面转换才有效。该位通常由操作系统在软件初始化期间设置。如果操作系统要实现多个虚拟8086任务，面向页面的保护或面向页面的虚拟内存，则必须将PG位置1。

### 5.2.1页面框架

页帧是物理内存连续地址的4K字节单位。页面开始于字节边界，并且大小固定。

### 5.2.2线性地址

线性地址通过指定页表，该表内的页和该页内的偏移量间接引用物理地址。 下图显示了线性地址的格式。

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-8.gif)

下图显示了处理器如何通过查询两个级别的页表将线性地址的DIR，PAGE和OFFSET字段转换为物理地址。寻址机制将DIR字段用作页面目录的索引，将PAGE字段用作页面目录确定的页面表的索引，并使用OFFSET字段对页面表确定的页面中的字节进行寻址。

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-9.gif)

### 5.2.3页表

页表只是32位页说明符的数组。页表本身就是一个页，因此包含4 KB的内存或最多1K 32位条目。

两级表用于寻址内存页面。在较高级别是页面目录。页目录最多可寻址第二级的1K页表。第二级的页表最多可处理1000页。因此，一页目录寻址的所有表都可以寻址1M页（2 ^（20））。因为每个页面包含4K字节2 ^（12）字节），所以一个页面目录的表可以跨越80386的整个物理地址空间（2 ^（20）乘以2 ^（12）= 2 ^（32））。

当前页面目录的物理地址存储在CPU寄存器CR3中，也称为页面目录基址寄存器（PDBR）。内存管理软件可以选择对所有任务使用一个页面目录，对每个任务使用一个页面目录，或两者的某种组合。 

### 5.2.4页表条目

任一级别的页表中的条目都具有相同的格式，下图说明了这种格式：

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-10.gif)

#### 5.2.4.1页面框架地址

页面框架地址指定页面的物理起始地址。由于页面位于4K边界上，因此低阶12位始终为零。在页面目录中，页面框架地址是页面表的地址。在第二级页表中，页框架地址是包含所需内存操作数的页框架的地址。

#### 5.2.4.2当前位

Present位指示页表项是否可以用于地址转换。P = 1表示可以使用该条目。

当在任一级别的页表中P = 0时，该条目对于地址转换均无效，其余条目可用于软件使用；条目中的其他位均未经过硬件测试。下图说明的P=0时页表项的格式：

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-11.gif)

如果在尝试使用页表条目进行地址转换时在任一级别的页表中P = 0，则处理器会发出页异常的信号。在支持分页虚拟内存的软件系统中，不存在页面的异常处理程序可以将所需的页面带入物理内存。然后可以重新执行引起异常的指令。 

请注意，页面目录本身没有当前位。在挂起相关任务时，页面目录可能不存在，但是在分派任务之前，操作系统必须确保TSS中CR3映像指示的页面目录存在于物理内存中。

#### 5.2.4.3访问位和脏位

这些位在页表的两个级别中提供有关页使用情况的数据。除页面目录条目中的脏位外，这些位由硬件设置；其他位由硬件设置。但是，处理器不会清除任何这些位。

在对页面进行读或写操作之前，处理器将页面表的两个级别中的相应访问位都设置为1。

在写入该页表条目所覆盖的地址之前，处理器将第二页页表中的脏位设置为1。目录条目中的脏位未定义。

支持分页虚拟内存的操作系统可以使用这些位来确定在内存需求超出可用物理内存时要从物理内存中删除的页面。操作系统负责测试和清除这些位。

#### 5.2.4.4读/写和用户/主管位

这些位不用于地址转换，而是用于页面级保护，处理器在与地址转换同时执行的页面级保护。

### 5.2.5页面转换缓存

为了最大程度地提高地址转换的效率，处理器将最新使用的页表数据存储在片上缓存中。仅当必要的分页信息不在高速缓存中时，才必须引用两个级别的页表。

页面翻译缓存的存在对于应用程序程序员是不可见的，但对于系统程序员而言则是不可见的。每当更改页表时，操作系统程序员都必须刷新高速缓存。可以使用以下两种方法之一刷新页面翻译缓存：

1. 通过用

   MOV

   指令重载CR3 ；例如：

   ```
   MOV CR3，EAX
   ```

2. 通过执行任务切换到具有与当前TSS不同的CR3图像的TSS。

## 5.3段和页面组合的转换

下图总结了启用分页时从逻辑地址到物理地址的转换的两个阶段。通过在两个阶段中适当选择选项和参数，内存管理软件可以实现几种不同样式的内存管理。

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-12.gif)

### 5.3.1平面架构

当80386用于执行为没有分段的体系结构设计的软件时，可能会很有效地“关闭” 80386的分段功能。80386没有禁用分段的模式，但效果相同可以通过在段寄存器中首先加载包含整个32位线性地址空间的描述符选择器来实现。加载后，段寄存器不需要更改。80386指令使用的32位偏移量足以解决整个线性地址空间。

### 5.3.2跨多个页面的段

80386的体系结构允许段大于或小于页面大小（4千字节）。例如，假设一个段用于寻址和保护跨越132 KB的大型数据结构。在支持分页虚拟内存的软件系统中，整个结构不必一次在物理内存中。该结构分为33页，可能不存在任何数量。应用程序程序员不需要知道虚拟内存子系统正在以这种方式分页结构。

### 5.3.3跨多个段的页面

另一方面，段可能小于页面的大小。例如，考虑一个小的数据结构，例如信号量。由于段提供了保护和共享，因此为每个信号量创建一个单独的段可能很有用。但是，由于系统可能需要许多信号量，因此为每个信号量分配页面效率不高。因此，将页面中的许多相关段聚类可能会很有用。

### 5.3.4不对齐的页面和段边界

80386的体系结构不强制页面和段的边界之间的任何对应关系。页面完全允许包含一个段的结尾和另一个段的开头。同样，一个段可能包含一页的结尾和另一页的开头。

### 5.3.5对齐的页面和段边界

但是，如果内存管理软件强制执行页面和段边界之间的某些对应关系，则它可能会更简单。例如，如果仅以一页为单位分配段，则可以组合段和页分配的逻辑。不需要逻辑来解释部分使用的页面。

### 5.3.6每段的页表

![img](https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig5-13.gif)

如图所示 ，一种可以进一步简化空间管理软件的空间管理方法是在段描述符和页面目录条目之间保持一一对应的关系 。每个描述符都有一个低22位为零的基地址。换句话说，基址由页表的第一个条目映射。一个段可以有1到4兆字节的任何限制。根据限制，该段包含在1到1K页帧中。因此，一项任务被限制在1K段（对于许多应用程序来说是足够的数量），每个段最多包含4 MB。描述符，对应的页面目录条目和对应的页面表可以同时分配和释放。