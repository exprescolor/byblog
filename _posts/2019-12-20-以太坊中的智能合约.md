---
layout:     post 
title:      以太坊
subtitle:   以太坊中的智能合约
date:       2019-12-20
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 区块链
---

#### 智能合约

- 智能合约是运行在区块链上的一段代码，代码的逻辑定义了合约的内容
- 智能合约的账户保存了合约当前的运行状态
   - balance：当前余额
   - nonce：交易次数
   - code：合约代码
   - storage：存储，存储结构是一棵MPT
- Solidity是智能合约最常用的语言，语法上和JavaScript很相近
- 代码实例：
   - ![QLHTPg.jpg](https://s2.ax1x.com/2019/12/20/QLHTPg.jpg)

#### 外部账户如何调用智能合约

- 创建一个交易，接收地址为要调用的那个智能合约的地址，data域填写要调用的函数及其参数的编码值
- ![QLqQtU.jpg](https://s2.ax1x.com/2019/12/20/QLqQtU.jpg)

#### 一个合约如何调用另一个合约中的函数

- 1.直接调用
   - ![QLqGc9.jpg](https://s2.ax1x.com/2019/12/20/QLqGc9.jpg)
- 2.使用address类型的call()函数调用
   - ![QLqdAK.jpg](https://s2.ax1x.com/2019/12/20/QLqdAK.jpg)
- 3.代理调用delegatecall()
   - ![QLqgBt.jpg](https://s2.ax1x.com/2019/12/20/QLqgBt.jpg)

#### fallback()函数

- ![QLqbBq.jpg](https://s2.ax1x.com/2019/12/20/QLqbBq.jpg)

#### 智能合约的创建和运行

- ![QLL3Uf.jpg](https://s2.ax1x.com/2019/12/20/QLL3Uf.jpg)

#### 汽油费

- ![QLLbxH.jpg](https://s2.ax1x.com/2019/12/20/QLLbxH.jpg)
- 全节点是没有办法判断智能合约是否会导致死循环的，这是一个停机问题（从理论上可以证明不存在这样一个算法，能够对任意给定的输入程序判断出这个程序是否会造成停机）。
- 所以就把这个问题推给发起交易的那个账户，所以就引入了汽油费机制。发起一个对智能合约的调用，就要支付相应的汽油费
   - AccountNonce：交易的序号，用于防止replay attack
   - GasLimit：愿意为这笔交易支付的最大的汽油费
   - Price：单位汽油的价格
   - Recipient：收款人的地址
   - Amount：转账金额
   - Payload：data域，用于存放“调用的合约中的哪一个函数，这个函数的参数取值是什么”
- 当一个全节点收到一个对智能合约调用的请求之后，先按照合同中给出的GasLimit，算出可能花掉的最大汽油费，然后一次性的把汽油费从发起调用的账户上扣掉。然后再根据实际执行的情况，算出实际扣掉的汽油费。

#### 错误处理

- 以太坊中的交易执行起来具有原子性，一个交易要么全部执行，要么全部不执行，不会只执行一部分。所以如果在执行智能合约的过程当中发生了错误，会导致整个交易的执行回滚，退回到开始执行之前的状态。

#### 嵌套调用

- ![QLxz8K.jpg](https://s2.ax1x.com/2019/12/20/QLxz8K.jpg)
- 是否发生连锁式的回滚取决于调用智能合约的方式。
   - 如果智能合约是直接调用的话，他会触发连锁式的回滚，整个交易都会发生回滚
   - 如果是使用call()这种方式，就不会引起连锁式回滚，只会使当前的交易失败，返回一个false的返回值

#### 智能合约可以得到的区块信息

- block.blockhash(uint blockNumber) returns (bytes32)：给定区块的哈希，仅对最近的256个区块有效而不包括当前区块
- block.coinbase(address)：挖出当前区块的矿工地址
- block.difficulty(uint)：当前区块难度
- block.gaslimit(uint)：当前区块gas限额
- block.number(uint)：当前区块号
- block.timestamp(uint)：自unix epoch起始当前区块以秒计的时间戳

#### 智能合约可以获得的调用信息

- msg.data(bytes)：完整的calldata
- msg.gas(uint)：剩余gas
- msg.sender(address)：消息发送者（当前调用）
- msg.sig(bytes4)：calldata前的四字节（也就是函数标识符）
- msg.value(uint)：随消息发送的wei的数量
- now(uint)：目前区块的时间戳（block.timestamp）
- tx.gasprice(uint)：交易的gas价格
- tx.origin(address)：交易发起者（完全的调用链）

#### 智能合约中的地址类型

![lSuXDO.png](https://s2.ax1x.com/2019/12/23/lSuXDO.png)