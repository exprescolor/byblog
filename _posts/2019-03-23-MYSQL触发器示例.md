---
layout:     post
title:      MySql触发器示范
subtitle:   用MySQL实现一个触发器
date:       2019-03-23
author:     秋酱
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - MySQL
    - 触发器
---

#    MySQL触发器示例

## 1触发器要求：
假设有一个借书记录表，规定一张借书卡一学期只能借至多2本书，当借第三本书时，触发器触发，输出不能借三本书，并自动回滚。

## 2首先数据库
创建数据库 `借书记录borrow`：
各属性（卡号,借书证号,借期,还期）的类型如下:
```
	cno		char(7),
	bno		char(8),
	borrow_date	date,
	return_date	date,
```

插入两条数据：
```
1. ('cno4','bno1','2010-9-4','2010-9-10');
2. ('cno4','bno2','2010-9-4','2010-9-10');

```
结果如下图所示：

![](https://ws2.sinaimg.cn/large/006tKfTcly1g1cs1kjrgcj31ak0lkjuf.jpg)

# 3创建触发器
代码如下：
```
DELIMITER ||
CREATE TRIGGER borrow_warning AFTER INSERT ON borrow FOR EACH ROW
BEGIN
DECLARE num int;
DECLARE msgs VARCHAR(60);
set num =(select count(cno) FROM borrow WHERE cno=new.cno);
IF num>2 THEN
select 'cannot brorow three books' into @msgs;
delete FROM borrow WHERE cno=new.cno AND bno=new.bno ;
END IF;
END ||
```
创建触发器后记得取消符号声明：`DELIMITER ;`，后面才能正常使用`;`

需要注意的是：

1 MySQL的触发器中没有`print`函数，所以我定义了一个变量`msgs`,当借了三本书条件触发时，我将需要输出的信息传入变量`msgs`

2 MySQL的触发器中没有`rollback`，所以我曲线救国，用`delete`将新插入的那条记录删除（当然这条删除语句在某些情况下会删错，这里我就懒得深究了）

## 3查看结果
在此之前我们以插入了两条记录，并且两条记录的`cno`都是`cno4`，先查看一下`msgs`的值：
![](https://ws3.sinaimg.cn/large/006tKfTcly1g1csbipsy2j30rq0bk3z4.jpg)
还没有值，因为我们的触发器还没有触发（虽然我事先插入两条数据，再创建的触发器，不过逻辑上肯定是应该`msgs=null`的）。那么我再插入一条数据：

![](https://ws1.sinaimg.cn/large/006tKfTcly1g1csdo1d34j327y0go0vt.jpg)

报错了，提示无法更新`borrow`表，其实就是插入了同一个`cno`的第三条借书记录，触发了触发器，再看看`msgs`是什么呢：

![](https://ws2.sinaimg.cn/large/006tKfTcly1g1csf7on7sj30tm0c6q3q.jpg)

这正是我们想要的结果。

## 4结语

MySQL触发器是个天坑，花了我几个小时写这玩意儿，有条件的同学去用`sqlserver`试试。