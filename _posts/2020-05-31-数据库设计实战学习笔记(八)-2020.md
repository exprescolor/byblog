---
layout:     post                        # 使用的布局（不需要改）
title:      数据库设计实战学习笔记(八)              # 标题
subtitle:   新零售平台数据库分库分表的各种方式及容灾备份  # 副标题
date:       2020-05-31                  # 时间
author:     AhogeK                      # 作者
header-img:  https://tr3.cbsistatic.com/hub/i/r/2016/08/02/ffb48ac0-b355-4aec-b814-04c79e1e1bfd/resize/1200x/292c4adbf288356b843876804b244d69/mysqlhero.jpg    # 这篇文章标题背景图片
catalog: true                           # 是否归档
tags:                                   # 标签
    - MySQL
    - 慕课学习笔记
---
### 垂直切分与水平切分
#### 什么是切分
* 出于降低数据库负载和缩表的目的,通常我们要对单节点的MySLQ数据库做切分
* 对数据库切分的方案: 垂直切分 | 水平切分

#### 垂直切分
* 垂直切分是按照业务对数据表分类,然后把一个数据库拆分成多个独立的数据库

#### 垂直切分的作用
* 垂直切分可以把数据库的并发压力,分散到不同的数据库节点
* 数据切分并不能减少单表数据量

#### 垂直切分的缺点
* 不能跨MySQL节点做表连接查询,只能通过接口方式解决
* 跨MySQL节点的事务,需要用分布式事务机制来实现

#### 水平切分
* 水平切分是按照某个字段的某种规则,把数据切分到多张数据表

#### 水平切分的缺点
* 不同数据表的切分规则并不一致,要根据实际业务来确定
* 集群扩容较为麻烦,需要迁移大量的数据

#### 冷热数据分离
* 添加新的分片,硬件成本和时间成本很大,所以要慎重
* 可以对分片数据做冷热数据分离,把冷数据移出分片来缩表

*MySQL可以MyCat中间件对数据进行冷热切分,然后可以将冷数据归档,归档数据库可以使用TokuDB引擎,非常的适合*

#### 使用垂直切分,还是水平切分?
* 在项目逐步迭代升级的过程中,先是从单节点演化为水平切分的

垂直切分就需要将原先的单体项目多元化,这个过程就会更为复杂,比如业务系统1模块需要调用业务系统2模块的方法,就不能单单通过*new*进行调用,一般情况下不建议进行垂直切分

### 安装MyCat
#### 没有数据库中间件的年代
* 没有数据库中间件的时候,通常把数据切分规则记录在数据表,然后通过查询数据表得知,查询的数据保存在什么MySQL节点

#### 数据库中间件
* 数据库中间件保存了水平切分的规则,直接可以切分和整合数据

#### 为什么选用MyCat?
* MyCat是基于Java语言的开源数据库中间件产品
* 相较于其他中间件产品,MyCat的切分规则最多,功能最全
* 数据库中间件产品并不会频繁更新升级

#### 下载MyCat中间件
* [http://mycat.org.cn/](http://mycat.org.cn/)
**强烈建议使用1.6.6.1版本，目前新版本出现了建表表为大写以及mod-long未生效等问题**

#### 安装OpenJDK镜像
* 建议使用OpenJDK1.8环境部署MyCat

```
docker pull adoptopenjdk/openjdk8
docker tag adoptopenjdk/openjdk8 openjdk8
docker rm adoptopenjdk/openjdk8
```

#### 创建Java容器
* 创建Java容器,在数据卷放入MyCat

``docker run -d -it --name mycat1 -v mycat1:/root/server --privileged --net=host openjdk8``
**-it 指在后台运行且不退出**

**需要服务器开放两个端口**
```
firewall-cmd --zone=public --add-port=8066/tcp --permanent
firewall-cmd --zone=public --add-port=9066/tcp --permanent
firewall-cmd --reload
```
*9066端口用于获取MyCat信息*

### 配置PXC集群负载均衡
#### 高可用的MyCat
* 为了实现高可用,我们一共需要配置两个MyCat容器

#### MyCat主要的配置文件
* server.xml
  * 端口,全局主键的生成方式,虚拟逻辑库,虚拟账户
* schema.xml
  * 配置数据库连接与切分规则
* rule.xml
  * 让我们自主定制切分规则

#### MyCat到底是什么?
MyCat是MySQL数据库中间件产品,运行的时候会把自己虚拟成MySQL数据库,包括虚拟的逻辑库和数据表

#### 配置server.xml文件
* 可以配置端口号 \ 账号信息 \ 全局主键方式等等

```xml
<mycat:server>
  <user name="admin">
    <property name="password">123456</property>
    <property name="schemas">neti</property>
  </user>
</mycat:server>
```

#### 什么是读写分离
* 数据库中间件把读写人物分别发送给不同节点执行,可以降低单一节点的负载
* PXC集群不需要设置读写分离,做负载均衡即可
* Replication集群主从节点功能明确,需要做读写分离

#### 配置PXC负载均衡
* 修改schema.xml文件,加入PXC负载均衡的内容

```xml
<dataHost name="pxc1" maxCon="1000" minCon="10" balance="0" writeType="1" dbType="mysql" dbDriver="native" switchType="1" slaveThreshold="100">
  <heartbeat>select user()</heartbeat>
  <writeHost host="p1w1" url="192.168.50.120:9001" user="root" password="123456"></writeHost>
  <writeHost host="p1w2" url="192.168.50.216:9001" user="root" password="123456"></writeHost>
  ......
</dataHost>
```

### 配置Replication读写分离
#### 读写分离的方案
* Replication镜像不能配置双向主从同步，所以只能使用1写3读

#### 配置读写分离
* 修改schema.xml文件，加入读写分离的配置

```xml
<dataHost name="rep1" maxCon="1000" minCon="10" balance="3" writeType="1" dbType="mysql" dbDriver="native" switchType="1" slaveThreshold="100">
  <heartbeat>select user()</heartBeat>
  <writeHost host="r1w1" url="192.168.50.120:9003" user="root" password="123456">
    <readHost host="r1w2" url="192.168.50.216:9003" user="root" password="123456" />
    ....
  </wirteHost>
</dataHost>
```

**关于更多的MyCat配置可参考官方的权威指但第七章（pg70)**

### 配置虚拟库和虚拟表
#### 虚拟逻辑库和关系表
* 因为MyCat并不存储数据，所以必须要配置可以使用的虚拟逻辑库和关系表

#### 使用什么逻辑库
* <dataNode>标签可以设置使用的真实逻辑库

```xml
<dataNode name="dn1" dataHost="pxc1" database="neti" />
<dataNode name="dn2" dataHost="pxc2" database="neti" />
<dataNode name="dn3" dataHost="rep1" database="neti" />
<dataNode name="dn4" dataHost="rep2" database="neti" />
<dataNode name="tdn1" dataHost="pxc1" database="t1" />
<dataNode name="tdn2" dataHost="pxc2" database="t1" />
<dataNode name="tdn3" dataHost="rep1" database="t2" />
<dataNode name="tdn4" dataHost="rep2" database="t2" />
```

#### 设置虚拟的逻辑库
* <schema>标签可以设置虚拟逻辑库，<table>标签可以设置虚拟关系表

```xml
<schema name="t2" checkSQLschema="false" sqlMaxLimit="100">
  <table name="teacher" type="global" dataNode="tdn3,tdn4" />
  <table name="student" type="mod-long" dataNode="tdn3,tdn4" />
</schema>
```

#### 修改mod-long算法
* MyCat默认的mod-long是按照三个分片切分数据，所以这里我们要改下默认值
* 修改rule.xml文件中的mod-long分片数量

```xml
<function name="mod-long" class="io.mycat.route.function.PartitionByMod">
  <property name="count">2</property>
</function>
```

### 启动MyCat
#### MyCat日志文件
* MyCat日志文件主要有console.log和mycat.log，存放在logs目录

#### 启动MyCat
* 为MyCat/bin目录中所有sh命令设置最高权限
  * ``chmod -R 777 ./*.sh``
* 启动MyCat程序
  * ``./startup_nowrap.sh``
  * 新版本启动使用``./mycat start`` 在bin目录下执行

### MyCat实现水平切分与垂直切分
#### MyCat实现垂直切分
* 垂直切分就是把数据表切分成独立的逻辑库

#### MyCat实现水平切分
* MyCat具有很多水平切分算法，用户可以随意订制切分规则
  * ![水平切分规则](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-05-31%2023-38-37.png)

#### MyCat性能参数
* 每天2亿数据的实时查询案例(p242)
* 物联网26亿数据的案例(p242)
* 大型分布式零售系统案例(p243)

### 什么是全局表
#### 全局表
* 数据字典表或者数据量不是很大的业务表，都可以定义成全局表
* 全局表的数据在每个分片中都是相同的

#### 配置全局表

```xml
<table name="teacher" dataNode="tdn3,tdn4" type="global" />
```

#### 全局表的SQL路由
* 查询语句，MyCat会随机路由给一个分片执行
* INSERT、DELETE、UPDATE语句会路由给每个分片去执行
  * ``DELETE FROM teacher WHERE id=1000;``

### 水平切分规则：主键求模
#### 主键求模切分
* 主键求模切分可以把数据均匀的切分到分片中
* 这种切分规则适合初始数据量大，但是数据增幅不大的场合

#### 主键求模切分的缺点
* 数据不分类直接存储，以后维护的成本比较高，例如增添新分片

### 水平切分规则：枚举值
#### 枚举值切分
* 枚举值切分是根据固定字段的枚举值来切分数据。枚举值要提前规定好，而且必须是整数类型。

#### 枚举值文件
* 枚举值文件的序号从0开始，0代表第一个分片，然后以此类推

#### 定义算法“函数”
* 首先在rule.xml文件中声明枚举值算法函数

```xml
<function name="partition-by-city" class="io.mycat.route.function.PartitionByFileMap">
  <property name="mapFile">city.txt</property>
</function>
```

#### 定义数据表规则
* 在rule.xml文件中声明枚举值数据表规则

```xml
<tableRule name="sharding-by-city">
  <rule>
    <columns>city_id</columns>
    <algorithm>partition-by-city</algorithm>
  </rule>
</tableRule>
```

#### 引用切分规则
* 最后要在声明虚拟表的时候引用枚举值切分规则
  * ``<table name="company" dataNode="tdn3,tdn4" rule="sharding-by-city" />``

#### MyCat热加载配置
*进入9066端口的MyCat执行 ``reload @@config_all``*

### 避免跨分片表连接：父子表
#### 跨分片的表连接
* 跨分片的表连接需要在网络中传输大量的数据，所以MyCat不支持跨分片表连接

#### 父子表机制
* 两张都是用了水平切分的数据表，要实现表连接查询，需要定义父子表关系
* 父表数据切分到什么分片，子表的数据会切分到同样的分片

![father&son](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-06-01%2000-47-33.png)

#### 配置父子表
* 父表可以有切分规则，但是子表不能配置切分规则

```xml
<table name="customer" primaryKey="ID" dataNode="tdn1,tdn2" rule="sharding-by-city">
  <childTable name="payment" primaryKey="ID" joinKey="customer_id" parentKey="id" />
  ... ...
</table>
```
**配置primaryKey可以开启MyCat的缓存**

### 全局主键
#### 数据库主键自增长的弊病
* 使用数据库本地的主键自增长，会产生重复的主键记录

#### 使用全局主键
* 在数据库集群环境中，应该使用中间件来生成主键值
* MyCat支持多种主键生成方式，其中最好的是Zookeeper方式

#### 本地文件方式（不推荐）
* MyCat按照计数器的方式生成自增长的主键值
* 计数器的参数被保存在文本文档中

#### 数据库方式(不推荐)
* MyCat按照计数器的方式生成自增长的主键值
* 计数器的参数被保存到数据库中

#### 本地时间戳方式
* MyCat根据本地时间戳和机器ID，生成18位的主键值
* 因为生成的主键值都是偶数，所以无法用在主键求模切分规则上

#### Zookeeper时间戳方式(推荐)
* 利用Zookeeper生成时间戳主键值，主键字段必须使用bigint类型
* Zookeeper生成的时间戳主键值包含奇数和偶数，可以用于主键值求模切分
* 我们可以对Zookeeper建立集群，实现分布式生成主键

#### 安装Zookeeper
* 下载安装Zookeeper官方镜像
  * ``docker pull zookeeper``
* 启动Zookeeper容器
  * ``docker run -d --name z1 -p 2181:2181 -p 3888:3888 -p 2888:2888 --net=swarm_mysql zookeeper``

#### 配置Zookeeper时间戳主键（一）
* 编辑server.xml文件，修改sequnceHandlerType属性
  * ``<property name="sequnceHandlerType">3</property>``
* 编辑myid.properties文件，配置参数信息
  * ```
    loadZk=true
    zkURL=192.168.50.120:2181
    clusterId=mycat-cluster-1
    myid=mycat_fz_01
    clusterNodes=mycat_fz_01
    ```

获取全局主键的值：
``SELECT NEXT VALUE FOR MYCATSEQ_GLOBAL;``

插入全局主键的语句 （id类型需要更改为BIGINT）
``INSERT INTO company(id,name,city_id) VALUES(NEXT VALUE FOR MYCATSEQ_GLOBAL,"test",411);``