---
layout:     post                    # 使用的布局（不需要改）
title:      Spring框架学习笔记2            # 标题 
subtitle:   AOP(面向方面编程)-前置通知             #副标题
date:       2019-10-20              # 时间
author:     AhogeK                      # 作者
header-img: img/spring_post.png   #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - java
    - Spring框架
    - AOP
    - 学习笔记
---

> AOP（面向方面编程）是一种编程范式，一般适用于具有横切逻辑的场合，如何访问控制、事物管理、性能监测等，旨在通过允许横切关注点的分离，提高模块化。

## AOP 术语
  * 切面（Aspect）
  * 连接点（JoinPoint）
  * 切入点（Pointcut）
  * 通知/增强处理（Advice）
  * 目标对象（Target Object）
  * 代理对象（Proxy Object）
  * 织入（Weaving）

## 基于 XML 配置文件的 AOP 实现
### 前置通知
> 其中DEMO中需要spring-aop提供的实现包，spring-aspects包提供对 AspectJ 的支持，aopalliance AOP 联盟提供的规范包，aspectjweaver 提供使用 @Aspect 注解方式

* service

```java
package com.ssm.service;

public interface ProductService {
	
	// 定义抽象方法 browse，模拟某用户浏览某商品
	public void browse(String loginName, String ProductName);
	
}
```
* service 实现类

```java
package com.ssm.service.impl;

import com.ssm.service.ProductService;

public class ProductServiceImpl implements ProductService {
	
	// 实现方法 browse，模拟某用户浏览商品
	@Override
	public void browse(String loginName, String ProductName) {
		System.out.println("执行业务方法browse");
	}

}
```

* AOP 日志通知类

```java
package com.ssm.aop;

import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

import org.aspectj.lang.JoinPoint;

public class AllLogAdvice {

	// 此方法将作为前置通知
	public void myBeforeAdvice(JoinPoint joinPoint) {
		// 获取业务方法参数
		List<Object> args = Arrays.asList(joinPoint.getArgs());
		// 日志格式字符串
		String logInfoText = "前置通知：" + new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()) + " " + args.get(0).toString()
				+ " 浏览商品 " + args.get(1).toString();
		// 将日志信息输出到控制记录台
		System.out.println(logInfoText);
	}
	
}
```

*声明一个 JoinPoint 接口类型的参数 joinPoint, String 会自动注入实例。通过 joinPoint 的 getArgs() 方法， myBeforAdvice 就能获取业务方法 browse 的参数 loginName 和 productName。*

* ApplicationContext

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:aop="http://www.springframework.org/schema/aop"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        https://www.springframework.org/schema/aop/spring-aop.xsd">
	<!-- 实例化业务类的Bean -->
	<bean id="productService" class="com.ssm.service.impl.ProductServiceImpl" />
	<!-- 实例化日志通知/增强处理类（切面）的Bean -->
	<bean id="allLogAdvice" class="com.ssm.aop.AllLogAdvice" />
	<!-- 配置AOP -->
	<aop:config>
		<!-- 配置日志切面 -->
		<aop:aspect id="logaop" ref="allLogAdvice">
			<!-- 定义切入点，切入点采用正则表达式，含义是对 browse 的方法进行拦截 -->
			<aop:pointcut expression="execution(public void browse(String,String))" id="logpointcut"/>
			<!-- 将日志通知类中的 myBeforeAdvice 方法指定为前置通知 -->
			<aop:before method="myBeforeAdvice" pointcut-ref="logpointcut"/>
		</aop:aspect>
	</aop:config>
</beans>
```

*上面配置的代码中的 execution 是切入点的指示符，切入点表达式支持模糊匹配：*
* ``public * browse(String,String)``：“*”表示匹配所有类型的返回值。
* ``public void *(String,String)``：“*”表示匹配所有方法名。
* ``public void browse(..)``：“..”表示匹配所有的参数个数和类型。
* ``* com.ssm.service.*.*(..)``：表示匹配 com.ssm.service 包下所有类的所有方法。
* ``* com.ssm.service..*.*(..)``：表示匹配 com.ssm.service 包及其子包下所有类的所有方法。

<br>

* 测试类TestAOP

```java
package com.ssm;

import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

import com.ssm.service.ProductService;

public class TestAOP {

	public static void main(String[] args) {
		// 初始化 spring 容器， 加载 applicationContext.xml 配置
		ApplicationContext ctx = new ClassPathXmlApplicationContext("applicationContext.xml");
		// 通过容器获取配置中 productService 的实例
		ProductService productService = (ProductService) ctx.getBean("productService");
		// 调用 productService 中的 browse 方法
		productService.browse("阿夸", "Meaqua 贴贴");
	}
}
```

*如果遇到 **Unable to locate Spring NamespaceHandler for XML schema namespace** 一般是漏导相关的包了*

从控制台结果可以看到，在业务方法 browse 执行前，先输出了日志类的通知类 ALlLogAdvice 中 myBeforeAdvice 方法产生的日志记录