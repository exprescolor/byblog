---
layout:     post 
title:      Nginx教程01
subtitle:   Nginx
date:       2019-10-10
author:     张鹏
header-img: img/tag-bg-o.jpg
catalog: true   
tags:                         
    - Nginx
---

#### 什么是Nginx？

- Nginx是一个轻量级且高性能的Http和反向代理服务器，同时也是一个IMAP/POP3/SMTP代理服务器。

#### Nginx下载并启动

- 下载安装：直接解压缩即可
- 启动方式有两种
   - 直接双击：
      - 直接双击nginx.exe即可，会有个内容框一闪而过，其实已经启动成功了，只需要打开访问地址即可看到效果（http://127.0.0.1）
      - ![Nginx启动后结果](https://github.com/Jokerboozp/Jokerboozp.github.io/raw/master/img/%E6%89%B9%E6%B3%A8%202019-10-10%20142221.png)
      - nginx启动之后，在任务管理器中会有两个进程，这是正常的，一个是守护进程，一个是工作进程。
      - 需要关闭nginx的话需要去任务管理器手动关闭。
   - 命令行方式启动
      - 用命令行进入nginx的安装目录下，执行start nginx即可
      - 关闭只需要输入nginx -s stop
      - ![nginx命令行启动关闭](https://github.com/Jokerboozp/Jokerboozp.github.io/raw/master/img/%E6%89%B9%E6%B3%A8%202019-10-10%20142949.png)

#### Nginx配置文件

- nginx.conf是Nginx的核心配置文件。主要内容有：
- 1. 端口号
   - `listen 80;`
- 2. 页面存放位置
   - `root html;`：意思是页面都存放在nginx的html文件夹下
- 3. 欢迎页面
   - `index index.html index.htm`：默认会访问index.html或者index.htm文件

#### 正向代理和反向代理

- 正向代理是一个位于客户端和目标服务器之间的代理服务器（中间服务器）。为了从原始服务器取得内容，客户端向代理服务器发送一个请求，并且指定目标服务器，之后代理向目标服务器转交并且将获得的内容返回给客户端。正向代理的情况下客户端必须要进行一些特别的设置才能使用。
- 反向代理正好相反，对于客户端来说，反向代理就好像目标服务器。并且客户端不需要进行任何设置。客户端向反向代理发送请求，接着反向代理判断请求走向何处，并将请求转交给客户端。客户端并不会感知到反向代理后面的服务，也因此不需要客户端做任何设置，只需要把反向代理服务器当作真正的服务器就好了。
- **两者的区别**
   - 正向代理需要你主动设置代理服务器ip或者域名进行访问，由设置的服务器IP或者域名去获取内容并返回；而反向代理不需要你做任何设置，直接访问服务器真实IP或域名，但是服务器内部会自动根据访问内容进行跳转及内容返回，你不知道他最终访问的是那些机器。
   - 正向代理是代理客户端，为客户端收发请求，使得真实客户端对服务器不可见；而反向代理是代理服务器端，为服务器收发请求，使得真实服务器对客户端不可见。
   - 从上面的描述也能看得出来正向代理和反向代理最关键的两点区别：
      - **是否指定目标服务器**
      - **客户端是否要做设置**
   - 下面用一张图来表示两者的区别
   - ![正向代理和反向代理](https://github.com/Jokerboozp/Jokerboozp.github.io/raw/master/img/3257886-8ab4925e268f5780.png)
   - 正向代理中，proxy和client同属于一个LAN，对Server透明；反向代理中，proxy和server同属于一个LAN，对client透明。实际上proxy在两种代理中做的事都是代为收发请求和响应，不过从结构上来看正好左右互换了一下。所以把前者叫做正向代理，后者叫做反向代理
   - 从途径上来区分
      - 正向代理是为了在防火墙内的局域网提供访问Internet的途径。另外还可以使用缓冲特性减少网络使用率
      - 反向代理的用途是将防火墙外面的服务器提供给Internet用户访问。同时还可以完成诸如负载均衡等功能。
   - 从安全性来区分：
      - 正向代理允许客户端通过它访问任意网站并且隐蔽客户端自身，因此你必须采用安全措施来确保仅为通过授权的客户端提供服务
      - 反向代理对外是透明的，访问者并不知道自己访问的是代理。对访问者而言，他以为访问的就是原始服务器。
   - **应用举例**
      - 正向代理：翻墙——>用户A无法访问facebook，但是能访问服务器B，而服务器B可以访问facebook。于是用户A访问服务器B，通过服务器B去访问facebook，，服务器B收到请求后，去访问facebook，facebook把响应信息返回给服务器B，服务器B再把响应信息返回给A。这样，通过代理服务器B，就实现了翻墙。
      - 反向代理：负载均衡
      - 反向代理还有保护和隐藏原始资源服务器、加密和SSL加速、缓存静态内容、压缩、减速上传、安全、外网发布等功能

#### 利用Nginx实现反向代理

- 本例子用两个tomcat本地服务器实现。具体可自行配置tomcat配置文件的端口号。
- 1. 首先启动端口号为8111的tomcat服务器
- 2. 修改nginx.conf。
- location / 表示处理所有请求
- proxy_pass http://127.0.0.1:8111; 表示把请求都交给http://127.0.0.1:8111来处理

```

#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

//重点是这里，修改location为刚刚打开的tomcat地址

        location / {
            proxy_pass http://127.0.0.1:8111;
        }


//到这里结束


        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}

```

- 3. 重启nginx并访问
- 使用如下命令重启nginx：
   - nginx -s reload
- 然后访问刚刚的tomcat地址。会发现已经反向代理到tomcat了。
- **既然可以直接输入地址访问，为什么还要通过地址反向代理到tomcat呢？为什么不直接使用tomcat？**
   - 因为nginx在处理静态文件的吞吐量上面比tomcat好很多，通常他们两个配合，不会把所有请求都交给tomcat，而是把静态请求交给nginx，动态请求（jsp，servlet、struts等）交给tomcat，从而达到动静分离的效果。