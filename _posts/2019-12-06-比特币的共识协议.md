---
layout:     post 
title:      区块链
subtitle:   比特币的共识协议
date:       2019-12-06
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 区块链
---

#### 数字货币与纸质货币的区别

- 纸质货币是中心化的记账系统，而数字货币是去中心化的记账系统。
- 数字货币的主要挑战就是怎样避免double spending attack
   - double spending attack是指：纸质货币是由央行管控的，所以可以避免造假，但是数字货币直接复制一份就可以花出去，这就是double spending attack

![](https://vi1.xiu123.cn/live/2019/12/06/11/1003v1575602272040949370.jpg)

- 上图是一个简单的区块链交易
- 有两个哈希指针，一个是验证交易是否被改动，一个是验证当前交易的来源
- B给了F5个比特币，别的区块接收到交易之后，会从当前区块往B的来源回推，就会发现B已经花掉了5个比特币，所以交易是非法的
- A——B，A需要B的地址，A的签名，地址是通过公钥推算出来的（B的公钥取哈希，经过一些转换得到的）；B需要知道A的公钥，这样就可以知道是谁的转账
- **私钥签名，公钥验证**
- 每个交易都有输入和输出两部分
   - 输入部分：说明币的来源，自己的公钥
   - 输出部分：给出收款人的公钥的哈希
   - **加密指的是用接收者的公钥进行加密操作，接收者收到之后用私钥解密**
   - 每个交易的输入是一段脚本，包括给出的公钥，也是在输入的脚本里指定的；每个交易的输出也是一段脚本；
   - 验证每个交易是不是合法的，就是要把当前这个交易的输入脚本和前面那个交易的输出脚本拼接在一起，看能不能顺利执行，如果能执行，就说明是合法的。如下图所示

![](https://vi3.xiu123.cn/live/2019/12/06/11/1003v1575602882863679606.jpg)

- 实际情况中，每个区块可以包含很多个交易，这些交易就组成一个Merkle Tree，每个区块分为block header和block body两部分
- Block header 包含了一些区块的宏观信息：用的是哪一个版本的协议，区块链中指向前一个区块的哈希指针，Merkle Tree的根哈希值，挖矿的难度目标域值target（nBits），随机数nonce
- Block body包含了交易列表

#### 分布式共识
- **那么这些交易内容是怎么写到区块链中的？**
   - 每个节点可以发布交易，每个账户也可以发布交易，这个交易是广播给所有结点的，谁来决定哪些交易应该被放在下一个区块中，用什么样的顺序排放？
   - 每个节点独自决定，在本地构造出单独的区块链，这样会导致一致性问题。区块链是一个去中心化的账本，所以这样一个账本的内容要有一个统一的内容，也就是账本的内容要取得分布式的共识（distribated consensus）
- 分布式共识的一个简单的例子：分布式的哈希表
   - 首先介绍两个结论：
   - 1.FLP结论：在一个异步系统里，网络延时没有上限，如果系统中有一个成员是faulty的，就没办法达成共识
   - 2.CAP Theorem：任意一个分布式系统，下面的三个性质对多只能满足两个（Consistency：一致性；Availability：可用性；Partition tolerance：分区容差）
- 分布式共识一个比较著名的协议：Paxos（他保证了一致性）
- **比特币中的共识协议**
   - 特需要解决的问题是有些节点是有恶意的，这样怎么设计一个共识协议。
   - 比特币设计了一个投票系统，利用计算力来进行投票
   - 每个节点都可以在本地组装出一个候选区块，把他认为合法的交易放在这个区块里，然后就开始尝试各种nonce值，如果某个结点找到了H(block header)小于等于target的nonce，那么他就获得了记账权，也就是往比特币这个去中心化的帐本中写入下一个区块的权力。只有找到nonce，获得记账权，才能发布下一个区块，其他节点在接收到这个区块之后，会验证这个区块的合法性（先验证block header的内容对不对，检查header中的nBits域是否满足比特币协议中规定的难度要求，检查nonce，检查是不是整个header的哈希小于等于目标域值，也就是说，发布区块之后，别的节点要进行确认，你是不是真正获得了记账权；接着验证block body中的交易列表是不是合法的：1.要有一个合法的签名，2.以前没有人花过。如果有任意一个要求不满足，那么这个区块是不会被接收的）
   - 分叉攻击

![](https://vi2.xiu123.cn/live/2019/12/06/11/1003v1575604327752272232.jpg)

- 上图是分叉攻击的示意图，通过往区块链中间位置插入一个区块，来回滚一个已经发生过的交易
- 这两个交易都是合法的，因为当前区块的分叉没有进行相同内容的交易，但是A-A这个交易不是在最长合法链上
   - 如果两个节点在差不多的时间找到符合条件的nonce，他们都可以把区块发布出去，那么就会出现两个等长的分叉
   - ![](https://vi1.xiu123.cn/live/2019/12/06/11/1003v1575604542905086450.jpg)
   - 那么这两个都是最长合法链。比特币在缺省环境下，她会接受他最先接受到的那个区块，所以不同节点，根据在网络中的位置不同，有些节点可能先接收到1的区块，有些节点可能先接收到2的区块，如果在接受之后又往下发展了一个新的区块，那么就代表他认可这个区块，没有发展新的区块则代表不认可
   - 也就是说在两个等长的合法链的情况下，这个状态会维持一段时间，直到其中一个抢先一步产生下一个区块，这样它就变成了最长合法链

#### 为什么竞争记账权

- 只有获得记账权的节点才嫩南瓜产生新的比特币（block reward）
- 比特币的产生途径只有这一种方法，而且每经过20万个节点，得到的比特币奖励就会减半。刚开始的时候发现一个符合要求的nonce的奖励是50个比特币，现在已减少至12.5个比特币。
- 比特币争夺记账权的过程就是挖矿，找到了合法的nonce，就获得了记账权。