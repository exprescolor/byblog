---
title: 操作系统相关优化策略
subtitle:  日常工作中遇到的操作系统层的一些问题，总结下来持续更新
date: 2017-06-21
header-img: img/123.jpg
catalog: true
tags: system
---

#### 原则和目的

提高服务器性能有很多方法，比如按照服务器的功能性，区分web服务器，数据库服务器，应用中间件服务器，数据中间价服务器。在硬件资源有限的情况下，最大的提升服务器的性能和资源利用率，提高服务器的并发处理能力，提高服务器的安全性。通过调整系统参数来提高系统内存、CPU、内核资源的使用率，通过禁用不必要的服务、端口，来提高系统的安全性，更好的发挥系统的可用性。总的来说通过对OS的一些调整，可以在不提高成本的前提下，完成一些力所能及的安全加固，性能优化。

#### 安全优化

###### 经历过几次安全问题
* 服务器使用弱密码被入侵，当时使用的是AWS，采用的流量计价方式是带宽不设封顶，按照流量计费，因使用弱密码被入侵成为DDos别人的肉鸡，几天时间产生了大量的流量费用。
* php应用被挂码，植入挖矿程序，cpu mem爆表，正常业务无法运行。
* 被友商DDos直接把官网干挂。
* 使用未知非官方镜像，容器内有挖矿程序，服务器cpu 内存使用率只用到79%，隐藏深操作系统层的监控不报警，察觉困难。
* 爬虫，很多人不会遵循robots协议，随意的爬，有时候会导致后端服务器的压力增加，影响正常业务。

###### login相关
* 修改sshd默认22端口，启用一个非1-1023的随机端口，一般选择在50000以上，可以通过/etc/services查看常见的协议与port的对应记录
* 禁止使用root直接进行登录
* 禁止使用密码登陆 PasswordAuthentication no
* 禁止Root用户直接登陆 PermitRootLogin no 可以添加一个普通用户并为此普通用户赋权可以sudo -i
* 禁用DNS反向解析 UseDNS no
* 使用堡垒机或跳板机，后端所有服务器只允许通过某一台或几台进行登陆跳转，无法直连后端服务器
* 打开并记录secure日志，可以收集到elk中，根据失败次数统计并报警。或者使用shell实现，自动添加secure日志中的失败ip到hosts.deny中，也可以使用denyhosts工具，官方网站：http://denyhosts.sourceforge.net/

```
[root@zzr-blog shell]# cat secure.sh 
#! /bin/bash
cat /var/log/secure|awk '/Failed/{print $(NF-3)}'|sort|uniq -c|awk '{print $2"="$1;}' > /opt/shell/black.list
for i in `cat  /opt/shell/black.list`
do
  IP=`echo $i |awk -F= '{print $1}'`
  NUM=`echo $i|awk -F= '{print $2}'`
  if [ ${#NUM} -gt 1 ]; then
    grep $IP /etc/hosts.deny > /dev/null
    if [ $? -gt 0 ];then
      echo "sshd:$IP:deny" >> /etc/hosts.deny
    fi
  fi
done

添加crontab一分钟执行一次
```

* 使用hosts.allow 和hosts.deny 限制可以使用ssh协议的ip范围，一般只放开需要ssh堡垒机的ip地址，或部分内网IP地址段

```
/etc/hosts.allow文件中
sshd:ip:allow （也可以是ip段/子网掩码，例如192.168.0.0/255.255.255.0）

配合/etc/hosts.deny使用
sshd:all:deny

这两个文件支持多种服务例如httpd vsftpd等，服务进程名:主机列表:当规则匹配时可选的命令操作 server_name:hosts-list[:command]
```

* 设置密码复杂度过期天数等，如果能使用堡垒机或者禁用密码登陆会更好

```
[root@zzr-blog ~]# cat /etc/login.defs | grep "PASS_MAX_DAYS"
#	PASS_MAX_DAYS	Maximum number of days a password may be used.
PASS_MAX_DAYS	99999  #设置成想要的天数

[root@zzr-blog ~]# authconfig --passminclass=2 --update
[root@zzr-blog ~]#  grep "^minclass" /etc/security/pwquality.conf
minclass = 2  #设置密码复杂度，包括大写字母/小写字母/数字/特殊字符

[root@zzr-blog ~]# vim /etc/security/pwquality.conf
maxsequence = 3 #加到最后一行，在新密码中设置单调字符序列的最大长度，比如说abcde 12345 qwer等
```