---
layout:     post   				    # 使用的布局（不需要改）
title:      myvm分析	# 标题 
#subtitle:   脚本，xss #副标题
date:       2020-05-09 				# 时间
author:     s-seven 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - rev
---

# 背景知识

虚拟机：虚拟机，在计算机科学中的体系结构里，是指一种特殊的软件，可以在计算机平台和终端用户之间创建一种环境，而终端用户则是基于虚拟机这个软件所创建的环境来操作其它软件。虚拟机是计算机系统的仿真器，通过软件模拟具有完整硬件系统功能的、运行在一个完全隔离环境中的完整计算机系统，能提供物理计算机的功能。

​		我们今天分析的就是一个简单的基于寄存器的虚拟机实现（主程序myvm)，你可以将它理解为一个“自定义字节码”的language based virtual machine，它可以解释执行任何一段与当前指令集相符分程序。

编码格式：常见的编码格式如 ASCII、ISO-8859-1、GB2312、GBK、UTF-8等，分别用于不同的环境，今天的虚拟机用的是x86指令编码，这是一种汇编编码方式。X86指令由:

- 前缀字节prefix (非必需)

- 操作码opcode (必须)

- 内存/寄存器操作数字节ModR/M (非必需)

- 索引寻址描述字节SIB (非必需)

- 常数偏移字节/半字/字Displacement (非必需)

- 立即数字节/半字/字 Immediate (非必需)

  具体解释见![x86指令编码笔记][http://4ch12dy.site/2017/10/11/x86%E6%8C%87%E4%BB%A4%E7%BC%96%E7%A0%81%E7%AC%94%E8%AE%B0/X86%E6%8C%87%E4%BB%A4%E7%BC%96%E7%A0%81%E7%AC%94%E8%AE%B0/](http://4ch12dy.site/2017/10/11/x86指令编码笔记/X86指令编码笔记/)

汇编器：汇编器（Assembler）是将汇编语言翻译为机器语言的程序。 一般而言，汇编生成的是目标代码，需要经链接器（Linker）生成可执行代码才可以执行。 汇编语言是一种以处理器指令系统为基础的低级语言，采用助记符表达指令操作码，采用标识符表示指令操作数。

反汇编器：反汇编器是一种将机器语言转换为汇编语言的计算机程序——这与汇编器的目的相反。反汇编器与反编译器不同，反编译器的目标是高级语言而非汇编语言。反汇编器的反汇编输出通常格式化为适合人类阅读，而非用作汇编器的输入源，因此它主要是一个逆向工程工具。

# main函数代码

```assembly
; int __cdecl main(int, char **, char **)
main proc near
; __unwind {
push    r14
push    rbx
push    rax
mov     rbx, rsi
cmp     edi, 2
jnz     short loc_C47
lea     rsi, handler    ; handler
mov     edi, 2          ; sig
call    signal
mov     rdi, [rbx+8]
call    sub_CE0
mov     rbx, rax
lea     r14, unk_202014
mov     dword ptr [r14], 1
nop     word ptr [rax+rax+00000000h]
loc_C10:
mov     rdi, rbx
call    sub_E90
test    eax, eax
jnz     short loc_C24
cmp     dword ptr [r14], 0
jnz     short loc_C10
jmp     short loc_C35
loc_C24:
cmp     eax, 2
jnz     short loc_C35
lea     rdi, s          ; "Illegal Instruction"
call    puts
loc_C35:
mov     rdi, rbx
call    nullsub_1
loc_C3D:
xor     eax, eax
add     rsp, 8
pop     rbx
pop     r14
retn
loc_C47:
mov     rax, cs:stderr_ptr
mov     rdi, [rax]      ; stream
mov     rdx, [rbx]
lea     rsi, format     ; "Usage: %s <myvm program>\n"
xor     eax, eax
call    fprintf
jmp     short loc_C3D
; } // starts at BD0
main endp
```

## 指令集

PUSH    把字压入堆栈.

MOV     传送字或字节.

CMP     比较.(两操作数作减法,仅修改标志位,不回送结果).

JNE/JNZ     不等于时转移. 

LEA     装入有效地址.例: LEA DX,string ;把偏移地址存到DX. 

CALL      过程调用 

NOP     无操作 

TEST    测试.(两操作数作与运算,仅修改标志位,不回送结果). 

XOR     异或运算. 

ADD     加法. 

CMP     比较.(两操作数作减法,仅修改标志位,不回送结果). 

POP     把字弹出堆栈.

RET/RETF    过程返回.



