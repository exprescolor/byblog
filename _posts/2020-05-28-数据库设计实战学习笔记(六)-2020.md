---
layout:     post                        # 使用的布局（不需要改）
title:      数据库设计实战学习笔记(六)              # 标题
subtitle:   新零售系统数据库性能调优  # 副标题
date:       2020-05-28                  # 时间
author:     AhogeK                      # 作者
header-img:  https://tr3.cbsistatic.com/hub/i/r/2016/08/02/ffb48ac0-b355-4aec-b814-04c79e1e1bfd/resize/1200x/292c4adbf288356b843876804b244d69/mysqlhero.jpg    # 这篇文章标题背景图片
catalog: true                           # 是否归档
tags:                                   # 标签
    - MySQL
    - 慕课学习笔记
---
### MySQL压力测试
#### 什么是压力测试
> 压力测试是针对系统的一种性能测试,但是测试数据与业务逻辑无关,更加简单直接的测试读写性能.

#### 压力测试的指标
* **QPS**    ---------  每秒钟处理请求的次数
* **TPS**    ---------  每秒钟处理完的事务次数
* **相应时间** ---------  一次请求所需要的平均处理时间
* **并发量**  ---------  系统能同时处理的请求数

#### 压力测试工具
* **Mysqlslap**
* **Sysbench**
* **Jmeter**

#### Sysbench的相关测试指令
##### 线程测试
``sysbench --test=threads --num-threads=64 --thread-yields=100 --thread-locks=2 run``

##### CPU测试
``sysbench --test=cpu --cpu-max-prime=20000 run``

##### 内存测试
``sysbench --test=memory --memory-block-size=8k --memory-total-size=4G run``

##### 数据库测试
``sysbench --test=oltp --mysql-table-engine=myisam --oltp-table-size=1000000``

##### 磁盘测试
``sysbench --test=fileio --num-threads=16 --file-total-size=3G --file-test-mode=rndrw run``

#### 设置yum源
将需要更换的yum源放在 */etc/yum.repos.d* 目录中

然后执行
```shell
yum clean all
yum makecache
```

#### Sysbench安装

```shell
curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash
yum -y install sysbench
```

#### Sysbench基本语法
``sysbench script [options] [command]``

#### [OPTION]连接信息参数
| 参数名称 | 功能意义 |
| --- | --- |
| --mysql-host | IP地址 |
| --mysql-port | 端口号 |
| --mysql-user | 用户名 |
| --mysql-password | 密码 |
| --olpt-test-mode | 执行模式(simple、nontrx和complex) |
| --olpt-tables-count | 测试表的数量 |
| --olpt-table-size | 测试表的记录数 |
| --threads | 并发线程数 |
| --time | 测试执行时间 |
| --report-interval | 生成报告单的间隔时间 |

#### [COMMAND]命令
| 命令名称 | 功能意义 |
| ------- | ------- |
| prepare | 准备测试数据 |
| run | 执行测试 |
| cleanup | 清除测试数据 |

#### 准备测试数据
```shell
sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.50.228 --mysql-port=3306 --mysql-user=root --mysql-password=123456 --oltp-tables-count=10 --oltp-table-size=100000 prepare
```

#### 执行测试
```shell
sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=192.168.50.228 --mysql-port=3306 --mysql-user=root --mysql-password=123456 --olpt-test-mode=complex --threads=10 --time=600 --report-interval=10 run >> ~/report.log
```

### SQL语句优化
* 不要吧SELECT子句写成SELECT *
  * ``SELECT * FROM t_emp;``
* 谨慎使用模糊查询
  * ```sql
    SELECT ename FROM t_emp WHERE ename LIKE '%S%';
    SELECT ename FROM t_emp WHERE ename LIKE 'S%';
    ```
    **如果like使用了%写在开头查询时就无法使用到索引**
* 对ORDER BY排序的字段设置索引
  * ``SELECT ename FROM t_emp ORDER BY deptno`` (如果deptno有索引就能加快查询的速度)
* 少用IS NULL和IS NOT NULL
  * ```slq
    SELECT ename FROM t_emp WHERE comm IS NOT NULL;
    SELECT ename FROM t_emp WHERE comm >= 0;
    SELECT ename FROM t_emp WHERE comm =-1;
    ``` `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  `dname` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '部门名称',
  `is_del
    SELECT ename FROM t_emp WHERE deptno!=20;
    SELECT ename FROM t_emp WHERE deptno<20 AND deptno>20;
    ```
* 尽量少用OR运算符
  * ```sql
    SELECT ename FROM t_emp WHERE deptno=20 OR deptno=30;
    SELECT ename FROM t_emp WHERE deptno=20
    UNION ALL
    SELECT ENAME FROM t_emp WHERE deptno=30;
    ```
* 尽量少用IN和NOT IN运算符
  * ```sql
    SELECT ename FORM t_emp WHERE deptno IN (20,30);
    SELECT ename FORM t_emp WHERE deptno deptno=20
    UNION ALL
    SELECT ename FROM t_emp WHERE deptno=30;
    ```
* 避免条件语句中的数据类型转换
  * ``SELECT ename FROM t_emp WHERE deptno='20';``
* 在表达式左侧使用运算符和函数都会让索引失效
  * ```sql `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  `dname` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '部门名称',
  `is_del
    SELECT ename FROM t_emp WHERE salary*12>=100000;
    SELECT ename FROM t_emp WHERE salary>=100000/12;
    SELECT ename FROM t_emp WHERE year(hiredate)>=2000;
    SELECT ename FROM t_emp WHERE hiredate>='2000-01-01 00:00:00';
    ```

### MySQL参数优化
#### 优化最大连接数
* max_connections是MySQL最大并发连接数，默认值151
* MySQL允许的最大连接数上线是16384
* 实际连接数是最大连接数的85%较为合适
  * ```sql
    show variables like 'max_connections';
    show status like 'max_used_connections';
    ```
* MySQL为每个连接创建缓冲区，所以不应该盲目上调最大连接数
  * ```conf
    # 消耗约800M内存
    max_connections=3000
    ```

#### 优化请求堆栈
* back_log是存放执行请求的堆栈大小，默认是50

#### 修改并发线程数
* innodb_thread_concurrency代表并发线程数，默认是0
* 并发线程数应该设置为CPU核心数的两倍

#### 修改连接超时 `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
  `dname` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT '部门名称',
  `is_del
* wait-timeout是超时时间，单位是秒
* 连接默认超时为8小时，连接长期不用又不销毁，浪费资源
  * ```conf
    # 10分钟超时
    wait-timeout=600
    ```

#### InnoDB的缓存
InnoDB缓存不同于数据库缓存，它只将部分数据和部分索引进行缓存

#### 修改InnoDB缓存大小
* innodb_buffer_pool_size是InnoDB的缓存容量，默认是128M
* InnoDB缓存的大小可以设置为主机内存的70%～80%

### MySQL慢查询日志
#### 慢查询日志的作用
* 慢查询日志会把查询耗时超过规定时间的SQL语句记录下来
* 利用慢查询日志，定位分析性能的瓶颈
  * ``show variables like 'slow_query%';``

#### 开启满查询日志
* slow_query_log 可以设置慢查询日志的开闭状态
* long_query_time 可以规定查询超时的时间，单位是秒
  * ```
    slow_query_log = ON
    long_query_time = 1
    ```
通过日志得到的慢查询语句，可以通过在MYSQL中使用**EXPLAIN**来查看该查询语句的相关状况
