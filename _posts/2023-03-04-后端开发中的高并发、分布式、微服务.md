---
layout:     post
title:      后端开发中的高并发、微服务、分布式
subtitle:   如何理解高并发、微服务和分布式
date:       2023-03-04
author:     BY Magicsmx
header-img: img/post-bg-github-cup.jpg
catalog: true
tags:
    - 高并发
    - 微服务
    - 分布式
    - 后端开发
---

## 前言

&emsp;&emsp;随着网络的飞速发展，用户量级不断增加，后端服务也更加多样化，这时，如何保证系统能够同时并行处理大量请求，是互联网分布式系统架构设计中必须考虑的因素，本文介绍后端开发与实际架构设计中的高并发、分布式和微服务设计思想。  

## 一. 高并发

#### 1. 什么是高并发

&emsp;&emsp;高并发（High Concurrency）是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计保证系统能够同时并行处理很多请求。  
&emsp;&emsp;衡量并发程度的常用指标：  
&emsp;&emsp;（1）响应时间：系统对请求做出响应的时间。例如系统处理一个HTTP请求需要200ms，这个200ms就是系统的响应时间。  
&emsp;&emsp;（2）吞吐量：单位时间内处理的请求数量。  
&emsp;&emsp;（3）QPS：每秒响应请求数。一般来说，这个指标和吞吐量区分的没有这么明显。  
&emsp;&emsp;（4）TPS:每秒处理的事务数。  
&emsp;&emsp;（5）并发用户数：同时承载正常使用系统功能的用户数量。例如一个即时通讯系统，同时在线量一定程度上代表了系统的并发用户数。  

#### 2. 如何提升并发能力

&emsp;&emsp;提高系统并发能力的方式，方法论上主要有两种：垂直扩展（Scale Up）与水平扩展（Scale Out）。前者垂直扩展可以通过提升单机硬件性能或单机架构性能来提高并发性，但单机性能总是有极限的，互联网分布式架构设计高并发终极解决方案还是后者：水平扩展。

###### （1）垂直扩展：提升单机处理能力。
&emsp;&emsp;① 增强单机硬件性能，例如：增加CPU核数如32核，升级更好的网卡如万兆，升级更好的硬盘如SSD，扩充硬盘容量如2T，扩充系统内存如128G；  
&emsp;&emsp;② 在web层和db层添加一层缓存：例如使用redis（因为redis在内存，读取更加高效，而mysql在磁盘。大多数公司采用了以mysql作为主存储，redis作为辅助缓存存储的架构方式，以此加快数据读取的速度，提升性能，当服务中读的操作较多时，性能提升得尤为明显。当然，此时要注意缓存穿透、缓存击穿和缓存雪崩现象。）（并且redis具有单进程单线程的特性，天然具备原子性，防止数据脏读。一般的情况是先get读取redis，若没有读到则去读取db，然后将db读到的数据写入redis。注意缓存中的数据的key要设置一个有效时间，否则会导致越来越多的垃圾数据在内存中。）；  
&emsp;&emsp;③ 去掉自增主键id；  
&emsp;&emsp;④ mysql主从复制、读写分离：主从数据库只负责各自的读和写，极大程度缓解X锁和S锁的竞争。slave可以配置MyISAM引擎，提高查询性能节约系统开销。增加冗余，提高可用性。数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点。MySQL 默认采用异步复制方式，这样从节点不用一直访问主服务器来更新自己的数据，数据的更新可以在远程连接上进行，从节点可以复制主数据库中的所有数据库或者特定的数据库，或者特定的表。在开发工作中，有时候会遇见某个sql 语句需要锁表，导致暂时不能使用读的服务，这样就会影响现有业务，使用主从复制，让主库负责写，从库负责读，这样，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作。数据实时备份，当系统中某个节点发生故障时，可以方便的故障切换架构扩展随着系统中业务访问量的增大，如果是单机部署数据库，就会导致I/O访问频率过高。有了主从复制，增加多个数据存储节点，将负载分布在多个从节点上，降低单机磁盘I/O访问的频率，提高单个机器的I/O性能。  
&emsp;&emsp;⑤ 数据库分库分表：使用用户ID来分表分库路由，例如取模，实际中，用户ID更多是通过UUID来生成的，可以先将UUID进行hash取整数值，然后再进行取模。  分库：对库序号或表序号取模。  
&emsp;&emsp;⑥ CDN缓存；content delivery network内容分发网络而对于一些用户访问量巨大的网站而言，如果所有用户都去服务器请求数据，服务器会很快崩溃，并且在不同网络以及不同地区的用户，请求服务器的速度也不一样。为了提高这部分用户的访问速度，CDN 中又提出了新的网络架构，即创建一些最接近用户网络的边缘服务器，然后将文件缓存在这些边缘服务器（节点）上，这就是 CDN 缓存。当服务接入了 CDN 之后，浏览器本地缓存的资源过期之后，浏览器不是直接向源服务器请求资源，而是转而向 CDN 边缘节点请求资源。CDN 边缘节点中将用户的数据缓存起来，如果 CDN 中的缓存也过期了，CDN 边缘节点会向源服务器发出回源请求，从而来获取最新资源。  
&emsp;&emsp;⑦ 异步处理：异步与同步相对，当一个异步过程调用发出后，调用者在没有得到结果之前，就可以继续执行后续操作。也就是说无论异步方法执行代码需要多长时间，跟主线程没有任何影响，主线程可以继续向下执行。  
&emsp;&emsp;⑧ 动态网页静态化。：只能对一部分网页做静态化处理。适合大规模且相对变化不太频繁的数据。  
&emsp;&emsp;⑨ Gunicorn和gevent：Gunicorn是一个WSGI HTTP Server，是针对Python的、在Unix系统上运行的、用来解析HTTP请求的网关服务。它的特点是：能和大多数的Python web框架兼容；使用简单；轻量级的资源消耗；高性能。  

###### （2）水平扩展：增加服务器数量，就能线性扩充系统性能。
水平扩展对系统架构设计是有要求的，如何在架构各层进行可水平扩展的设计，以及互联网公司架构各层常见的水平扩展实践。常见的互联网分层架构如下图：
![](https://raw.githubusercontent.com/Magicsmx/Magicsmx.github.io/master/img/fenceng.png)
① 反向代理层如何水平扩展：通过DNS轮询，dns服务器对一个域名配置多个解析ip，每次DNS解析请求访问dns服务器，会轮询返回这些ip。当单体nginx性能存在瓶颈，增加服务器的数量，新增nginx的部署，增加ip数。就能够水平扩展反向代理层的性能，做到理论上的高并发；
② Web应用层的水平扩展：通过“nginx”实现，修改nginx.conf，设置多个web后端；
③ 服务层：服务层的水平扩展，是通过“服务连接池”实现的。站点层通过RPC-client调用下游的服务层RPC-server时，RPC-client中的连接池会建立与下游服务多个连接，当服务成为瓶颈的时候，只要增加服务器数量，新增服务部署，在RPC-client处建立新的下游服务连接，就能扩展服务层性能，做到理论上的无限高并发；
④ 数据层的水平扩展：如上数据库高并发技术。



## 二. 分布式

#### 1. 什么是后端开发中的分布式
&emsp;&emsp;后端开发系统架构中的分布式：将一个业务拆分为多个子业务，部署在多个服务器上。  


#### 2. 分布式与集群的区别
&emsp;&emsp;分布式：一个业务拆分为多个子业务，部署在多个服务器上。   
&emsp;&emsp;集群：同一个业务，部署在多个服务器上。集群主要的使用场景是为了分担请求的压力，也就是在几个服务器上部署相同的应用程序，通过负载均衡来分担客户端请求。  


## 三. 微服务

#### 1. 什么是后端开发中的微服务
&emsp;&emsp;微服务架构风格是一种将一个单一应用程序开发为一组小型服务的方法，每个服务运行在自己的进程中，服务间通信采用轻量级通信机制。这些服务围绕业务能力构建并且可通过全自动部署机制独立部署。这些服务共用一个最小型的集中式的管理，服务可用不同的语言开发，使用不同的数据存储技术。市面上目前典型主流的微服务架构有SpringBoot、SpringCloud、Dubbo，微服务兴起的时代，除了官方几个代表的框架外，各大厂商也开始了各自开源的分布式框架。除了上面说的Dubbo外，还有腾讯的Tars，京东的JSF，新浪的Motan等。  

#### 2. 如何将单体架构拆分成微服务架构
&emsp;&emsp;从单体架构到分布式微服务架构，我们可以把单体应用简单分为水平拆分或垂直拆分两种方式。  
&emsp;&emsp;如一个电商系统，包含：商品模块、会员模块、物流模块、支付模块、订单模块几个核心模块。  
&emsp;&emsp;水平拆分：单体应用把所有这些模块集中在一个电商系统里面，水平拆分后分为：商品系统、会员系统、物流系统、支付系统、订单系统。  
&emsp;&emsp;垂直拆分：例如会员系统可按会员等级分为：普通用户、VIP用户、超级VIP用户等。  


