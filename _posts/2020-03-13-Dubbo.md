---
layout:     post 
title:      分布式学习
subtitle:   Dubbo
date:       2020-03-13
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 分布式
---

# 架构生命周期

![8Pl9GF.png](https://s2.ax1x.com/2020/03/10/8Pl9GF.png)

## 第一时期

### 单一应用架构

all in one：所有的模块和代码都放在一起，技术也不分层

**问题**
1. 代码不具备可维护性
2. 容错性差（因为所有代码都写在JSP页面中，当用户访问或某些原因发生异常时：用户会直接看到异常信息，某些情况下，该错误会直接导致服务器宕机）

## 第一时期后阶段

### 解决方案

1. 分层开发（提高维护性）
2. MVC架构：MVC是一个基于Java WEB应用的设计模式
3. 服务器分离部署

特点：
1. MVC分层开发（提高了可维护性、解决了容错性问题）
2. 数据库和项目分离部署

问题：
随着用户访问量持续增加，单台应用服务器已无法满足需求
**解决方案**
集群

### 会出现如下问题
在互联网项目下，因单个tomcat默认并发量有限制，如果需求量过大，就会产生如下问题：
**高并发**
是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指通过设计保证系统能够同时并行处理很多请求。
高并发相关常用的一些指标有响应时间、吞吐量、每秒查询率QPS、并发用户数等
响应时间：系统对请求做出响应的时间。例如系统处理一个HTTP请求需要200ms，这个200ms就是系统的响应时间
吞吐量：单位时间内处理的请求数量
QPS：每秒响应请求数，在互联网领域，这个指标和吞吐量区分的没有那么明显
并发用户数：同时承载正常使用系统功能的用户数量

**高可用**
通常来描述一个系统经过专门的设计，从而减少停工时间，而保持其服务的高度可用性

**高性能**
是指服务响应时间快，（CPU/处理器/内存）特别是在高并发下响应时间不会急剧增加

### 提高系统的并发能力

提高系统并发能力大的方式，主要有两种：垂直扩展（Scale Up）和水平扩展（Scale Out）

垂直扩展：提升单机处理能力，垂直扩展的方式有两种：
（1）增强单机硬件性能，例如：增加CPU核数，升级更好的网卡，升级更好的硬盘，扩充硬盘容量，扩充系统内存
（2）提升单机架构性能：例如：使用Cache来减少IO次数，使用异步来增加单服务吞吐量，使用无锁数据结构来减少响应时间

水平扩展：只要增加服务器数量，就能线性扩充系统性能，水平扩展对系统架构设计是有要求的，难点在于如何在架构各层进行可水平扩展的设计

## 集群操作

集群：同一个业务，部署在多个服务器上
![8kAtUg.md.png](https://s2.ax1x.com/2020/03/11/8kAtUg.md.png)

特点：
支持高并发，支持高可用
**问题**

1. 集群用户的请求应该往哪里转发
2. Session如何共享

**解决**
转发请求使用Nginx反向代理和负载均衡
![8kEDWd.png](https://s2.ax1x.com/2020/03/11/8kEDWd.png)
session共享使用Redis Cluster集群
![8kVmpd.png](https://s2.ax1x.com/2020/03/11/8kVmpd.png)

## 出现的新问题

数据库的压力变大。我们通过nginx+tomcat集群方案支持高并发（应用的性能进行提升访问），但是数据库的负载能力慢慢增加。
所以怎么降低数据库层面的访问压力？
**解决方案**
读写分离（主从复制）
![8kZ3K1.png](https://s2.ax1x.com/2020/03/11/8kZ3K1.png)
特点：
主从数据库之间进行数据同步：master主要负责增删改操作，slave负责查询（读）操作
MySQL本身就支持master-slave的功能（主从复制）

## 使用搜索引擎环节数据库访问压力+能力
数据库本身对大数据量查询效率慢，对模糊查询支持不是很优秀。（所以即使做了读写分离，和诺功能也不能有效解决）。针对该问题，有必要引入全文检索服务器功能。

**目前市场上主流的搜索引擎技术**
Solr ElasticSearch
![8kmKXR.png](https://s2.ax1x.com/2020/03/11/8kmKXR.png)

## 引入缓存机制
随着访问量的持续增加，数据库的访问压力会持续增大，甚至无法满足需求。虽然做了主从复制，对于热点数据，如果每个都从数据库中查询的话，数据库会无法应对，甚至无法对外提供服务

**最佳解决方案：Redis**
1. 读写性能非常好
2. 提供了丰富的数据类型
3. 原子性

![8knGbq.png](https://s2.ax1x.com/2020/03/11/8knGbq.png)

## 对数据库的表进行水平/垂直拆分

一张表里面有1000条数据，查询的性能很高；如果有100万数据，查询的性能很慢
单个表性能做提升。（能力终归还是有限的）
**表为主**
**垂直**：
假设一张表里面有30个字段（id，姓名，身份证号，身高，性别，体重，手机号。。。。。。）
热数据/冷数据
user(id，姓名，身份证号，性别，手机号)
user_info(id，身高，体重。。。)
**水平**：
按照需求进行拆分
**分库分表**
采用第三方数据库中间件：mycat、sharding-jdbc、drds（阿里）
https://blog.csdn.net/jornada_/article/details/82947677
![](https://img-blog.csdn.net/20181005223747851?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pvcm5hZGFf/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
![8kMGqA.png](https://s2.ax1x.com/2020/03/11/8kMGqA.png)

## 当前设计特点

通过设计保证高并发，高可用（不断地对服务器进行扩容）
当前很多公司用的这种架构
![8kMIsJ.png](https://s2.ax1x.com/2020/03/11/8kMIsJ.png)

**问题**

1. 服务器价钱（忙闲不均问题）【服务器的维护、人工成本】
2. 可维护性差
3. 可扩展性差
4. 协同开发不方便（大家都去修改相同业务代码，易发生代码冲突/错误问题）
5. 单体架构（随着业务需求不断增加，应用代码会变得越来越多）。导致服务器部署时占用的硬盘也大

## 第二时期

**垂直应用架构**
当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，提升效率的方法之一是将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。

**水平拆分（横着拆）**

按照层来拆分
将一个大的应用拆分成多个小应用。
（entity、mapper、service、controller）
```java
parent pom //父工程（放所有的pom.xml）
common.jar //公共库（相关工具类）
entity.jar //java bean
mapper.jar //数据持久层
service.jar //业务逻辑层
web.war //web访问层
```
maven分层

**垂直拆分（竖着拆）**

按照功能拆分
将一个大的应用按照功能拆分成多个互不相干的小应用，每个应用都是一个独立的web应用程序=====>分布式
![8kYCjK.png](https://s2.ax1x.com/2020/03/11/8kYCjK.png)

**解决问题**

1. 维护性（如果发生需求变更，只需要更改某个应用模块即可）
2. 功能扩展（随着业务的不断增加，只需要创建新的web程序即可）
3. 协同开发（不同团队修改不同的代码）
4. 部署内容大小（性能扩展），如果哪台访问量大，只需要对该服务多部署几台即可

此时，用于加速前端页面开发的web框架（MVC）是关键

**问题**
1. 客户对页面的需求会越来越高。频繁修改页面需要重新部署后台应用程序，每一个应用从头到尾都是完整的。
2. 随着需求不断增加，需要很多互不相干的应用部署。这些应用之间一定会需要业务交互。

## 第三时期

当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。

**分布式服务架构**
分布式：将一个业务拆分成多个子业务，部署在不同的服务器上。

**问题**

**1.客户对页面的需求会越来越高。频繁修改页面需要重新部署后台应用程序，每一个应用从头到尾都是完整的。如何快速的响应多变的市场需求？**
答：页面+业务代码（前后端分离开发/部署）
![8kUtCd.png](https://s2.ax1x.com/2020/03/11/8kUtCd.png)

**2.随着需求不断增加，需要很多互不相干的应用部署。这些应用之间一定会需要业务交互。如何进行交互？**
![8karsx.png](https://s2.ax1x.com/2020/03/11/8karsx.png)
**分析**：
以前如果统一在一台服务器上，模块之间通过依赖jar完成调用
现在是在不同的服务器上做的部署（分布式），服务和服务之间通过进程调用

**解决方法**：RPC

## 架构的改变一定会带来一些新的技术和新的问题

问题：分布式事务、分布式锁、分布式session、分布式日志

## RPC带来的问题

1. 当服务越来越多，服务和服务之间的调用非常的混乱
2. 当服务器越来越多，容量的评估，小服务资源浪费等问题逐渐显现

## 第四时期

**流动计算架构**
当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。

**SOA（面向服务的架构）**
服务治理中间件：Dubbo、SpringCloud
基于访问压力实时管理集群容量，提高集群利用率

![8kDTIK.png](https://s2.ax1x.com/2020/03/11/8kDTIK.png)
Dubbo底层用的是RPC协议（Dubbo是一个RPC框架），SpringCloud底层用的是HTTP协议

## Dubbo

### 一、简介

#### 1.dubbo是什么

dubbo（开源分布式服务框架）。是阿里巴巴公司开源的一个高性能优秀的服务框架，使得应用可以通过高性能的RPC实现服务的输入和输出功能，可以和Spring框架无缝集成。

**RPC主要解决的问题**

1. 解决分布式系统中，服务之间的调用问题
2. 远程调用时，需要能够像本地调用一样方便，让调用者感知不到远程调用的逻辑

当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架（RPC）是关键

##### Zookeeper注册中心

**安装Zookeeper**
安装环境必须是JDK1.6版本以上。

**1.zookeeper目录解压**

![8k2EyF.png](https://s2.ax1x.com/2020/03/11/8k2EyF.png)
- bin目录
   - zookeeper的可执行脚本目录，包括zookeeper服务进程，zookeeper客户端等脚本
   - 其中.sh是Linux环境下的脚本，.cmd是Windows环境下的脚本
- conf目录
   - 配置文件目录，zoo_sample.cfg为样例配置文件，需要修改为自己的名称
   - 一般为zoo.cfg。log4j.properties为日志配置文件
- lib
   - zookeeper依赖的包
- contrib目录
   - 一些用于操作zookeeper的工具包
- recipes目录
   - zookeeper某些用法的代码示例

**2.Zookeeper修改配置文件**

![8k2mw9.png](https://s2.ax1x.com/2020/03/11/8k2mw9.png)
将conf下的zoo_simple.cfg复制一份改名为zoo.cfg即可

**1.tickTime**

- 时长单位为毫秒，为zookeeper使用的基本时间度量单位。例如，`1*tickTime`是客户端与zookeeper服务端的心跳时间。`2*tickTime`是客户端会话的超时时间。
- tickTime的默认值为2000毫秒，更低的tickTime值可以更快的发现超时问题，但也会导致更高的网络流量（心跳消息）和更高的CPU使用率（会话的跟踪处理）

**2.clientPort**

- zook服务进程坚挺的TCP端口，默认情况下，服务端会监听2181端口

**3.dataDir（默认是Linux目录结构）**

- 无默认配置，必须配置，用于配置存储快照文件的目录。如果没有配置dataLogDir，那么事务日志也会存储在此目录。

**安装Dubbo Monitor**

- GitHub下载master分支下的Dubbo Admin版本。
- 解压后利用maven打包Dubbo Admin
- 运行zookeeper server
- 运行Dubbo Admin打包后的jar包（`java -jar dubbo-admin-0.0.1-SNAPSHOT.jar `）
- 打开localhost:7001，输入用户名和密码即可进入Dubbo

#### 简单Demo创建

**需求功能：会议查询时，需要调用用户服务获取某个用户的联系方式。通过会议编号查询会议详细信息，同时还要查询出来是哪一位用户发布的会议**

**模块：会议管理模块（会议发布），用户服务模块（查询用户信息）**

**项目结构**
![8ZFTmt.png](https://s1.ax1x.com/2020/03/12/8ZFTmt.png)

- 1.用户服务模块

```java
//User
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class User implements Serializable {

    private String id;
    private String name;
    private String telphone;
}

//UserService
package com.sc.service;

import com.sc.entity.User;

public interface UserService {

    public User selectById(String id);
}

//UserServiceImpl
package com.sc.serviceimpl;

import com.sc.entity.User;
import com.sc.service.UserService;

public class UserServiceImpl implements UserService {
    @Override
    public User selectById(String id) {
        User user = new User();
        user.setId(id);
        user.setName("joker");
        user.setTelphone("15239593182");
        return user;
    }
}

//pom
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.sc</groupId>
  <artifactId>user_service_provider</artifactId>
  <version>1.0-SNAPSHOT</version>

  <name>user_service_provider</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
    </dependency>
  </dependencies>

</project>
```

- 2.会议管理模块

```java

//MeetingPub
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class MeetingPub implements Serializable {
    //主键ID
    private String id;
    //会议编号
    private String pcode;
    //会议标题
    private String title;
    //会议内容
    private String content;
}

//MeetingPubService
package com.sc.service;

import com.sc.entity.MeetingPub;

public interface MeetingPubService {

    public MeetingPub selectByPcode(String pcode);
}

//MeetingPubServiceImpl
package com.sc.serviceimpl;

import com.sc.entity.MeetingPub;
import com.sc.service.MeetingPubService;

public class MeetingPubServiceImpl implements MeetingPubService {
    @Override
    public MeetingPub selectByPcode(String pcode) {
        MeetingPub meetingPub = new MeetingPub();
        meetingPub.setId("1001");
        meetingPub.setPcode(pcode);
        meetingPub.setTitle("dubbo");
        meetingPub.setContent("dubbo是一个RPC框架，是一个分布式服务解决方案");
        return meetingPub;
    }
}

//pom
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.sc</groupId>
  <artifactId>meeting_service_consumer</artifactId>
  <version>1.0-SNAPSHOT</version>

  <name>meeting_service_consumer</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
    </dependency>
  </dependencies>

</project>

```

**服务最佳化**

创建上述的项目后，发现并不能实现功能（即在查询会议信息的时候并不能查询出发布用户信息）。按照原来的方式进行修改的话，会发现无法引入User，因为User在另一个微服务项目中，这时候就需要采用Dubbo提供的服务最佳化来完成相关功能。

**项目结构**
![8ZZDZn.png](https://s1.ax1x.com/2020/03/12/8ZZDZn.png)

- 1.meeting_interface_api（公共的服务接口）

```java
//User
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class User implements Serializable {

    private String id;
    private String name;
    private String telphone;
}

//UserService
package com.sc.service;

import com.sc.entity.User;

public interface UserService {

    public User selectById(String id);
}

//pom
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.sc</groupId>
  <artifactId>meeting_interface_api</artifactId>
  <version>1.0-SNAPSHOT</version>

  <name>meeting_interface_api</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
    </dependency>
  </dependencies>

</project>

```

- 2.meeting_service_consumer：服务消费者

```java
//MeetingPub
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;

@Data
public class MeetingPub implements Serializable {
    //主键ID
    private String id;
    //会议编号
    private String pcode;
    //会议标题
    private String title;
    //会议内容
    private String content;
    //用户ID
    private String uid;

    //关联用户
    private User user;
}

//MeetingPubServiceImpl
package com.sc.serviceimpl;

import com.sc.entity.MeetingPub;
import com.sc.entity.User;
import com.sc.service.MeetingPubService;
import com.sc.service.UserService;

public class MeetingPubServiceImpl implements MeetingPubService {

    private UserService userService;

    @Override
    public MeetingPub selectByPcode(String pcode) {
        MeetingPub meetingPub = new MeetingPub();
        meetingPub.setId("1001");
        meetingPub.setPcode(pcode);
        meetingPub.setTitle("dubbo");
        meetingPub.setContent("dubbo是一个RPC框架，是一个分布式服务解决方案");

        //调用user_service_provider信息
        User user = userService.selectById(meetingPub.getUid());
        meetingPub.setUser(user);
        return meetingPub;
    }
}


//pom
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.sc</groupId>
  <artifactId>meeting_service_consumer</artifactId>
  <version>1.0-SNAPSHOT</version>

  <name>meeting_service_consumer</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
    </dependency>
    <dependency>
      <groupId>com.sc</groupId>
      <artifactId>meeting_interface_api</artifactId>
      <version>1.0-SNAPSHOT</version>
    </dependency>
  </dependencies>

</project>

```

#### 提供者注册到注册中心

- 1.启动zookeeper和dubbo admin
- 2.用Spring配置声明暴露服务（配置在prvider的pom文件中）

```xml
<properties>
    <dubbo.version>2.7.5</dubbo.version>
</properties>
    
<dependencies>
    <dependency>
        <groupId>org.apache.dubbo</groupId>
        <artifactId>dubbo</artifactId>
        <version>${dubbo.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.dubbo</groupId>
        <artifactId>dubbo-dependencies-zookeeper</artifactId>
        <version>${dubbo.version}</version>
        <type>pom</type>
    </dependency>
</dependencies>
```
创建provider.xml文件(放置在resources目录中，请自行创建)

```xml

<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://dubbo.apache.org/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans-4.3.xsd        http://dubbo.apache.org/schema/dubbo        http://dubbo.apache.org/schema/dubbo/dubbo.xsd">

    <!-- 提供方应用信息，用于计算依赖关系 服务的应用名称：尽量和你的应用服务名一样-->
    <dubbo:application name="user_service_provider"  />

    <!-- 使用zookeeper注册中心暴露服务地址 -->
    <dubbo:registry protocol="zookeeper" address="127.0.0.1:2181" />

    <!-- 用dubbo协议在20880端口暴露服务 -->
    <dubbo:protocol name="dubbo" port="20880" />

    <!-- 声明需要暴露的服务接口 -->
    <dubbo:service interface="com.sc.service.UserService" ref="userServiceImpl" />

    <!-- 和本地bean一样实现服务 -->
    <bean id="userServiceImpl" class="com.sc.serviceimpl.UserServiceImpl" />
</beans>

```

#### 加载Spring配置

```java
package com.sc;

import org.springframework.context.support.ClassPathXmlApplicationContext;

import java.io.IOException;

/**
 * Hello world!
 *
 */
public class App 
{
    public static void main( String[] args ) throws IOException {
        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[] {"classpath:provider.xml"});
        context.start();
        System.in.read(); // 按任意键退出
    }
}

```

运行项目文件后，刷新dubbo admin即可看到提供者信息
![8ZMFqe.png](https://s1.ax1x.com/2020/03/12/8ZMFqe.png)

#### 消费者订阅注册中心

- 1.配置maven依赖，并通过Spring配置远程引用服务，创建consumer.xml

```xml
//pom.xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.sc</groupId>
  <artifactId>meeting_service_consumer</artifactId>
  <version>1.0-SNAPSHOT</version>

  <name>meeting_service_consumer</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
    <dubbo.version>2.7.5</dubbo.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
    </dependency>
    <dependency>
      <groupId>com.sc</groupId>
      <artifactId>meeting_interface_api</artifactId>
      <version>1.0-SNAPSHOT</version>
    </dependency>
    <dependency>
      <groupId>org.apache.dubbo</groupId>
      <artifactId>dubbo</artifactId>
      <version>${dubbo.version}</version>
    </dependency>
    <dependency>
      <groupId>org.apache.dubbo</groupId>
      <artifactId>dubbo-dependencies-zookeeper</artifactId>
      <version>${dubbo.version}</version>
      <type>pom</type>
    </dependency>
  </dependencies>

</project>

//consumer.xml

<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://dubbo.apache.org/schema/dubbo"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
               http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
               http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
               http://dubbo.apache.org/schema/dubbo        http://dubbo.apache.org/schema/dubbo/dubbo.xsd">

    <context:component-scan base-package="com.sc">
        <context:exclude-filter type="annotation" expression="org.springframework.stereotype.Controller"></context:exclude-filter>
    </context:component-scan>

    <!-- 消费方应用名，用于计算依赖关系，不是匹配条件，不要与提供方一样 -->
    <dubbo:application name="meeting_service_consumer"  />

    <!-- 使用zookeeper注册中心暴露发现服务地址 -->
    <dubbo:registry protocol="zookeeper" address="127.0.0.1:2181" />

    <!-- 生成远程服务代理，可以和本地bean一样使用demoService -->
    <dubbo:reference id="userService" interface="com.sc.service.UserService" />
</beans>
```

- 2.加载Spring配置

```java
package com.sc;

import com.sc.entity.MeetingPub;
import com.sc.service.MeetingPubService;
import org.springframework.context.support.ClassPathXmlApplicationContext;

import java.io.IOException;

/**
 * Hello world!
 *
 */
public class App 
{
    public static void main( String[] args ) throws IOException {
        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[] {"classpath:consumer.xml"});
        context.start();

        MeetingPubService meetingPubService = context.getBean(MeetingPubService.class);
        MeetingPub meetingPub = meetingPubService.selectByPcode("1001");

        System.out.println( meetingPub );
        System.in.read();
    }
}

//MeetingPubServiceImpl
package com.sc.serviceimpl;

import com.sc.entity.MeetingPub;
import com.sc.entity.User;
import com.sc.service.MeetingPubService;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class MeetingPubServiceImpl implements MeetingPubService {

    @Autowired
    private UserService userService;

    @Override
    public MeetingPub selectByPcode(String pcode) {
        MeetingPub meetingPub = new MeetingPub();
        meetingPub.setId("1001");
        meetingPub.setPcode(pcode);
        meetingPub.setTitle("dubbo");
        meetingPub.setContent("dubbo是一个RPC框架，是一个分布式服务解决方案");

        //调用user_service_provider信息
        System.out.println("-----远程服务访问---------"+userService);
        User user = userService.selectById(meetingPub.getUid());
        meetingPub.setUser(user);
        return meetingPub;
    }
}

```

- 运行项目后就能在dubbo admin看到消费者。
![8Z8s8s.png](https://s1.ax1x.com/2020/03/12/8Z8s8s.png)

## Dubbo和Springboot整合

- 1.利用Springboot创建用户微服务模块。功能：利用用户ID查询用户信息（简单的项目写法，这里直接上代码）

```java
//User.java
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
public class User implements Serializable {

    //用户ID
    private Integer userId;
    //用户名
    private String userName;
    //用户姓名
    private String userRealName;
    //用户性别
    private String userSex;
    //用户电话
    private String userTel;
    //用户邮箱
    private String userEmail;
    //用户密码
    private String password;
    //角色ID
    private Integer roleId;
    //用户生日
    private Date userBirth;
}

//UserMapper.java
package com.sc.mapper;

import com.sc.entity.User;
import org.apache.ibatis.annotations.Mapper;

import java.util.List;

@Mapper
public interface UserMapper {

    //查找所有用户
    List<User> getAllUser();

    //根据Id查找用户
    User getUserById(Integer userId);

    //删除用户
    void deleteUser(Integer userId);

    //更新用户
    void updateUser(User user);

    //新增用户
    void addUser(User user);

    //根据角色ID查询用户列表
    List<User> getUserByRoleId(Integer roleId);

    //通过用户名查找用户
    User getUserByName(String userName);

    //查询除了管理员外的用户列表
    List<User> getUserWithOutAdmin();

    //模糊查询用户
    List<User> searchUser(String userRealName);

}

//UserMapper.xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sc.mapper.UserMapper">

    <select id="getAllUser" resultType="com.sc.entity.User">
        SELECT * FROM user
    </select>

    <update id="updateUser" parameterType="com.sc.entity.User">
        update user
        <set>
            <if test="userName!=null">user_name=#{userName},</if>
            <if test="userRealName!=null">user_realname=#{userRealName},</if>
            <if test="userSex!=null">user_sex=#{userSex},</if>
            <if test="password!=null">password=#{password},</if>
            <if test="userEmail!=null">user_email=#{userEmail},</if>
            <if test="userTel!=null">user_tel=#{userTel},</if>
            <if test="roleId!=null">role_id=#{roleId},</if>
            <if test="userBirth!=null">user_birth=#{userBirth}</if>
        </set>
        where user_id=#{userId}
    </update>

    <select id="getUserById" parameterType="Integer" resultType="com.sc.entity.User">
        SELECT * FROM user where user_id=#{userId}
    </select>

    <select id="getUserByRoleId" parameterType="Integer" resultType="com.sc.entity.User">
        SELECT * FROM user where role_id=#{roleId}
    </select>

    <select id="getUserWithOutAdmin" resultType="com.sc.entity.User">
        SELECT * FROM user where role_id not in (1)
    </select>

    <select id="getUserByName" parameterType="String" resultType="com.sc.entity.User">
        SELECT * FROM user where user_name=#{userName}
    </select>

    <select id="searchUser" parameterType="String" resultType="com.sc.entity.User">
        SELECT * FROM user where user_realname like #{userRealName} and role_id not in (1)
    </select>

    <insert id="addUser" parameterType="com.sc.entity.User" useGeneratedKeys="true" keyProperty="userId">
        insert into user(user_id,user_name,user_realname,password,role_id,user_sex,user_tel,user_email,user_birth) values (#{userId},#{userName},#{userRealName},#{password},#{roleId},#{userSex},#{userTel},#{userEmail},#{userBirth})
    </insert>

    <delete id="deleteUser" parameterType="Integer">
        delete from user where user_id=#{userId}
    </delete>

</mapper>

//UserService.java
package com.sc.service;

import com.sc.entity.User;

import java.util.List;

public interface UserService {

    //查找所有用户
    List<User> getAllUser();

    //根据Id查找用户
    User getUserById(Integer userId);

    //删除用户
    void deleteUser(Integer userId);

    //更新用户
    void updateUser(User user);

    //新增用户
    void addUser(User user);

    //根据角色ID查询用户列表
    List<User> getUserByRoleId(Integer roleId);

    //通过用户名查找用户
    User getUserByName(String userName);

    //查询除了管理员外的用户列表
    List<User> getUserWithOutAdmin();

    //模糊查询用户
    List<User> searchUser(String userRealName);
}

//UserServiceImpl.java
package com.sc.serviceimpl;

import com.sc.entity.User;
import com.sc.mapper.UserMapper;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserMapper userMapper;

    @Override
    public List<User> getAllUser() {
        return userMapper.getAllUser();
    }

    @Override
    public User getUserById(Integer userId) {
        return userMapper.getUserById(userId);
    }

    @Override
    public void deleteUser(Integer userId) {
        userMapper.deleteUser(userId);
    }

    @Override
    public void updateUser(User user) {
        userMapper.updateUser(user);
    }

    @Override
    public void addUser(User user) {
        userMapper.addUser(user);
    }

    @Override
    public List<User> getUserByRoleId(Integer roleId) {
        return userMapper.getUserByRoleId(roleId);
    }

    @Override
    public User getUserByName(String userName) {
        return userMapper.getUserByName(userName);
    }

    @Override
    public List<User> getUserWithOutAdmin() {
        return userMapper.getUserWithOutAdmin();
    }

    @Override
    public List<User> searchUser(String userRealName) {
        if (userRealName!=null && !userRealName.equals(" "))
            userRealName="%"+userRealName+"%";
        else
            userRealName=null;
        return userMapper.searchUser(userRealName);
    }
}

//UserController.java
package com.sc.controller;

import com.sc.entity.User;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class UserController {

    @Autowired
    private UserService userService;

    //根据用户ID查询用户信息
    @RequestMapping("/user/{userId}")
    @ResponseBody
    public User getUserById(@PathVariable("userId")Integer userId){
        User user = userService.getUserById(userId);
        return user;
    }
}

//Application.java
package com.sc;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan(value = "com.sc.mapper")
public class BootUserServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(BootUserServiceApplication.class, args);
    }

}

//application.yml
spring:
  datasource:
    url: jdbc:mysql:///documents?useUnicode=true&characterEncoding=utf8&useSSL=false
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: root
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 100MB
server:
  port: 8082
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.sc.entity
  configuration:
    map-underscore-to-camel-case: true

//pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.5.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.sc</groupId>
    <artifactId>boot_user_service</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>boot_user_service</name>
    <description>Demo project for Spring Boot</description>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.1.1</version>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.10</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
            <version>5.1.41</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.junit.vintage</groupId>
                    <artifactId>junit-vintage-engine</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>

```

效果展示：

![8nYs6H.png](https://s1.ax1x.com/2020/03/13/8nYs6H.png)

- 2.创建文件微服务（同上，基本项目创建，直接上代码）

```java
//StudyFile.java
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
public class StudyFile implements Serializable {

    //文件ID
    private Integer studyfileId;
    //文件名称
    private String studyfileName;
    //上传人ID
    private Integer userId;
    //创建时间
    private Date createTime;
    //文件简介
    private String studyfileInfo;
    //文件审核状态
    private Integer studyfileStatus;
    //文件喜欢数
    private Integer studyfileFav;
    //文件评论数
    private Integer studyfileReview;
    //上传文件路径
    private String studyfilePath;
}

//StudyFileMapper.java
package com.sc.mapper;

import com.sc.entity.StudyFile;
import org.apache.ibatis.annotations.Mapper;

import java.util.List;

@Mapper
public interface StudyFileMapper {

    //上传文件
    void addStudyFile(StudyFile studyFile);

    //删除文件
    void deleteStudyFile(Integer studyfileId);

    //更新文件信息
    void updateStudyFile(StudyFile studyFile);

    //查看所有文件
    List<StudyFile> getAllStudyFile();

    //根据用户ID查看文件
    List<StudyFile> getStudyFileByUser(Integer userId);

    //根据文件ID查看信息
    StudyFile getStudyFileById(Integer studyfileId);

    //根据大类查看文件列表
    List<StudyFile> getFileByType(Integer childtypeId);

    //根据大类查看文件列表
    List<StudyFile> getFileByMainType(Integer maintypeId);

    //根据文件状态查看文件列表
    List<StudyFile> getFileByStatus(Integer studyfileStatus);

    //查看今日文件
    List<StudyFile> getTodayFile(Integer stufyfileStatus);

    //模糊查询文件
    List<StudyFile> searchFile(String studyfileName);

    //模糊查询以审核通过的文件
    List<StudyFile> searchPassFile(String studyfileName);

    //查询一年内每个月上传的文件数
    List<Integer> getYearPerMonthFile();
}

//StudyFileMapper.xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sc.mapper.StudyFileMapper">

    <select id="getAllStudyFile" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile
    </select>

    <update id="updateStudyFile" parameterType="com.sc.entity.StudyFile">
        update studyfile
        <set>
            <if test="studyfileName!=null">studyfile_name=#{studyfileName},</if>
            <if test="userId!=null">user_id=#{userId},</if>
            <if test="childtypeId!=null">childtype_id=#{childtypeId},</if>
            <if test="createTime!=null">create_time=#{createTime},</if>
            <if test="studyfileInfo!=null">studyfile_info=#{studyfileInfo},</if>
            <if test="studyfileStatus!=null">studyfile_status=#{studyfileStatus},</if>
            <if test="studyfileFav!=null">studyfile_fav=#{studyfileFav},</if>
            <if test="studyfileReview!=null">studyfile_review=#{studyfileReview},</if>
            <if test="studyfilePath!=null">studyfile_path=#{studyfilePath},</if>
            <if test="maintypeId!=null">maintype_id=#{maintypeId},</if>
            <if test="fileLevel!=null">file_level=#{fileLevel}</if>
        </set>
        where studyfile_id=#{studyfileId}
    </update>

    <select id="getStudyFileById" parameterType="Integer" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where studyfile_id=#{studyfileId}
    </select>

    <select id="getFileByType" parameterType="Integer" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where childtype_id=#{childtypeId} and studyfile_status=1
    </select>

    <select id="getFileByMainType" parameterType="Integer" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where maintype_id=#{maintypeId} and studyfile_status=1
    </select>

    <select id="getFileByStatus" parameterType="Integer" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where studyfile_status=#{studyfileStatus}
    </select>

    <select id="getStudyFileByUser" parameterType="Integer" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where user_id=#{userId}
    </select>

    <select id="searchFile" parameterType="String" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where studyfile_name like #{studyfileName}
    </select>

    <select id="searchPassFile" parameterType="String" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where studyfile_name like #{studyfileName} and studyfile_status=1
    </select>

    <select id="getYearPerMonthFile" resultType="Integer">
        select COUNT(*) from studyfile where year(create_time)=2020 GROUP BY MONTH(create_time);
    </select>

    <insert id="addStudyFile" parameterType="com.sc.entity.StudyFile" useGeneratedKeys="true" keyProperty="studyfileId">
        insert into studyfile(studyfile_id, studyfile_name, user_id, childtype_id, create_time, studyfile_info, studyfile_status, studyfile_fav, studyfile_review,studyfile_path,maintype_id,file_level)
        values
        (#{studyfileId},#{studyfileName},#{userId},#{childtypeId},#{createTime},#{studyfileInfo},#{studyfileStatus},#{studyfileFav},#{studyfileReview},#{studyfilePath},#{maintypeId},#{fileLevel})
    </insert>

    <delete id="deleteStudyFile" parameterType="Integer">
        delete from studyfile where studyfile_id=#{studyfileId}
    </delete>

    <select id="getTodayFile" parameterType="Integer" resultType="com.sc.entity.StudyFile">
        SELECT * FROM studyfile where to_days(create_time) = to_days(now()) and studyfile_status=#{studyfileStatus}
    </select>

</mapper>

//StudyFileService.java
package com.sc.service;

import com.sc.entity.StudyFile;

import java.util.List;

public interface StudyFileService {

    //上传文件
    void addStudyFile(StudyFile studyFile);

    //删除文件
    void deleteStudyFile(Integer studyfileId);

    //更新文件信息
    void updateStudyFile(StudyFile studyFile);

    //查看所有文件
    List<StudyFile> getAllStudyFile();

    //根据用户ID查看文件
    List<StudyFile> getStudyFileByUser(Integer userId);

    //根据文件ID查看信息
    StudyFile getStudyFileById(Integer studyfileId);

    //根据大类查看文件列表
    List<StudyFile> getFileByType(Integer childtypeId);

    //根据大类查看文件列表
    List<StudyFile> getFileByMainType(Integer maintypeId);

    //根据文件状态查看文件列表
    List<StudyFile> getFileByStatus(Integer studyfileStatus);

    //查看今日文件
    List<StudyFile> getTodayFile(Integer stufyfileStatus);

    //模糊查询文件
    List<StudyFile> searchFile(String studyfileName);

    //模糊查询以审核通过的文件
    List<StudyFile> searchPassFile(String studyfileName);

    //查询一年内每个月上传的文件数
    List<Integer> getYearPerMonthFile();
}

//StudyFileServiceImpl.java
package com.sc.serviceimpl;

import com.sc.entity.StudyFile;
import com.sc.mapper.StudyFileMapper;
import com.sc.service.StudyFileService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class StudyFileServiceImpl implements StudyFileService {

    @Autowired
    private StudyFileMapper studyFileMapper;

    @Override
    public void addStudyFile(StudyFile studyFile) {
        studyFileMapper.addStudyFile(studyFile);
    }

    @Override
    public void deleteStudyFile(Integer studyfileId) {
        studyFileMapper.deleteStudyFile(studyfileId);
    }

    @Override
    public void updateStudyFile(StudyFile studyFile) {
        studyFileMapper.updateStudyFile(studyFile);
    }

    @Override
    public List<StudyFile> getAllStudyFile() {
        return studyFileMapper.getAllStudyFile();
    }

    @Override
    public List<StudyFile> getStudyFileByUser(Integer userId) {
        return studyFileMapper.getStudyFileByUser(userId);
    }

    @Override
    public StudyFile getStudyFileById(Integer studyfileId) {
        return studyFileMapper.getStudyFileById(studyfileId);
    }

    @Override
    public List<StudyFile> getFileByType(Integer childtypeId) {
        return studyFileMapper.getFileByType(childtypeId);
    }

    @Override
    public List<StudyFile> getFileByStatus(Integer studyfileStatus) {
        return studyFileMapper.getFileByStatus(studyfileStatus);
    }

    @Override
    public List<StudyFile> getFileByMainType(Integer maintypeId) {
        return studyFileMapper.getFileByMainType(maintypeId);
    }

    @Override
    public List<StudyFile> getTodayFile(Integer studyfileStatus) {
        return studyFileMapper.getTodayFile(studyfileStatus);
    }

    @Override
    public List<StudyFile> searchPassFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchPassFile(studyfileName);
    }

    @Override
    public List<StudyFile> searchFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchFile(studyfileName);
    }

    @Override
    public List<Integer> getYearPerMonthFile() {
        return studyFileMapper.getYearPerMonthFile();
    }

}

//StudyFileController.java
package com.sc.controller;

import com.sc.entity.StudyFile;
import com.sc.service.StudyFileService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class StudyFileController {

    @Autowired
    private StudyFileService studyFileService;

    @RequestMapping("/studyfile/{studyfileId}")
    @ResponseBody
    public StudyFile getFileById(@PathVariable("studyfileId")Integer studyfileId){
        StudyFile studyFileById = studyFileService.getStudyFileById(studyfileId);
        return studyFileById;
    }
}

//Application.java
package com.sc;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan(value = "com.sc.mapper")
public class BootFileServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(BootFileServiceApplication.class, args);
    }

}

//application.yml
spring:
  datasource:
    url: jdbc:mysql:///documents?useUnicode=true&characterEncoding=utf8&useSSL=false
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: root
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 100MB
server:
  port: 8081
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.sc.entity
  configuration:
    map-underscore-to-camel-case: true

//pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.5.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.sc</groupId>
    <artifactId>boot_file_service</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>boot_file_service</name>
    <description>Demo project for Spring Boot</description>

    <properties>
        <java.version>1.8</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.1.2</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.10</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
            <version>5.1.41</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.junit.vintage</groupId>
                    <artifactId>junit-vintage-engine</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>

```

项目效果
![8n01Ej.png](https://s1.ax1x.com/2020/03/13/8n01Ej.png)

- 3.服务化最佳实践（创建maven项目，具体代码如下）

```java
//StudyFile.java
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
public class StudyFile implements Serializable {

    //文件ID
    private Integer studyfileId;
    //文件名称
    private String studyfileName;
    //上传人ID
    private Integer userId;
    //创建时间
    private Date createTime;
    //文件简介
    private String studyfileInfo;
    //文件审核状态
    private Integer studyfileStatus;
    //文件喜欢数
    private Integer studyfileFav;
    //文件评论数
    private Integer studyfileReview;
    //上传文件路径
    private String studyfilePath;
}

//User.java
package com.sc.entity;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

@Data
public class User implements Serializable {

    //用户ID
    private Integer userId;
    //用户名
    private String userName;
    //用户姓名
    private String userRealName;
    //用户性别
    private String userSex;
    //用户电话
    private String userTel;
    //用户邮箱
    private String userEmail;
    //用户密码
    private String password;
    //角色ID
    private Integer roleId;
    //用户生日
    private Date userBirth;
}

//StudyFileService.java
package com.sc.service;

import com.sc.entity.StudyFile;

import java.util.List;

public interface StudyFileService {

    //上传文件
    void addStudyFile(StudyFile studyFile);

    //删除文件
    void deleteStudyFile(Integer studyfileId);

    //更新文件信息
    void updateStudyFile(StudyFile studyFile);

    //查看所有文件
    List<StudyFile> getAllStudyFile();

    //根据用户ID查看文件
    List<StudyFile> getStudyFileByUser(Integer userId);

    //根据文件ID查看信息
    StudyFile getStudyFileById(Integer studyfileId);

    //根据大类查看文件列表
    List<StudyFile> getFileByType(Integer childtypeId);

    //根据大类查看文件列表
    List<StudyFile> getFileByMainType(Integer maintypeId);

    //根据文件状态查看文件列表
    List<StudyFile> getFileByStatus(Integer studyfileStatus);

    //查看今日文件
    List<StudyFile> getTodayFile(Integer stufyfileStatus);

    //模糊查询文件
    List<StudyFile> searchFile(String studyfileName);

    //模糊查询以审核通过的文件
    List<StudyFile> searchPassFile(String studyfileName);

    //查询一年内每个月上传的文件数
    List<Integer> getYearPerMonthFile();
}

//UserService.java
package com.sc.service;

import com.sc.entity.User;

import java.util.List;

public interface UserService {

    //查找所有用户
    List<User> getAllUser();

    //根据Id查找用户
    User getUserById(Integer userId);

    //删除用户
    void deleteUser(Integer userId);

    //更新用户
    void updateUser(User user);

    //新增用户
    void addUser(User user);

    //根据角色ID查询用户列表
    List<User> getUserByRoleId(Integer roleId);

    //通过用户名查找用户
    User getUserByName(String userName);

    //查询除了管理员外的用户列表
    List<User> getUserWithOutAdmin();

    //模糊查询用户
    List<User> searchUser(String userRealName);
}

//pom.xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.sc</groupId>
  <artifactId>boot_interface_api</artifactId>
  <version>1.0-SNAPSHOT</version>

  <name>boot_interface_api</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.10</version>
    </dependency>
  </dependencies>

</project>

```

**更改上述两个项目的项目结构，删除多余的实体类的service接口。并在pom文件中引入公共API。

```xml
<dependency>
            <groupId>com.sc</groupId>
            <artifactId>boot_interface_api</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
```
项目结构：
![8nyqHO.png](https://s1.ax1x.com/2020/03/13/8nyqHO.png)

- 4.服务和服务之间的调用。（根据文件ID查询到文件信息后，可以直接得到文件所属用户的全部信息）.也就代表，用户信息服务是提供者，文件信息服务是消费者，文件信息服务根据用户信息服务提供的信息来返回用户信息
   - 4.1 最佳化实践，分包。增加pom依赖

```xml
<dependency>
    <groupId>com.alibaba.boot</groupId>
    <artifactId>dubbo-spring-boot-starter</artifactId>
    <version>0.2.0</version>
</dependency>
```
   - 4.2 将提供者注册到注册中心去。修改yml文件，并在ServiceImpl添加dubbo的Service注解。最终在启动类中添加@EnableDubbo注解，使项目可以扫描到@Service注解

```java

//UserServiceImpl.java

package com.sc.serviceimpl;

import com.sc.entity.User;
import com.sc.mapper.UserMapper;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@com.alibaba.dubbo.config.annotation.Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserMapper userMapper;

    @Override
    public List<User> getAllUser() {
        return userMapper.getAllUser();
    }

    @Override
    public User getUserById(Integer userId) {
        return userMapper.getUserById(userId);
    }

    @Override
    public void deleteUser(Integer userId) {
        userMapper.deleteUser(userId);
    }

    @Override
    public void updateUser(User user) {
        userMapper.updateUser(user);
    }

    @Override
    public void addUser(User user) {
        userMapper.addUser(user);
    }

    @Override
    public List<User> getUserByRoleId(Integer roleId) {
        return userMapper.getUserByRoleId(roleId);
    }

    @Override
    public User getUserByName(String userName) {
        return userMapper.getUserByName(userName);
    }

    @Override
    public List<User> getUserWithOutAdmin() {
        return userMapper.getUserWithOutAdmin();
    }

    @Override
    public List<User> searchUser(String userRealName) {
        if (userRealName!=null && !userRealName.equals(" "))
            userRealName="%"+userRealName+"%";
        else
            userRealName=null;
        return userMapper.searchUser(userRealName);
    }
}

//Application.java
package com.sc;

import com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan(value = "com.sc.mapper")
@EnableDubbo
public class BootUserServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(BootUserServiceApplication.class, args);
    }

}

//application.yml
spring:
  datasource:
    url: jdbc:mysql:///documents?useUnicode=true&characterEncoding=utf8&useSSL=false
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: root
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 100MB
server:
  port: 8082
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.sc.entity
  configuration:
    map-underscore-to-camel-case: true
dubbo:
  application:
    name: boot_user_service
  registry:
    address: zookeeper://127.0.0.1:2181
  protocol:
    name: dubbo
    port: 20880

```

运行项目后即可在dubbo中查看到已添加提供者
![8n7QpV.png](https://s1.ax1x.com/2020/03/13/8n7QpV.png)

   - 4.2 将服务的消费者注册到注册中心去进行消费服务

```java
//StudyFileServiceImpl.java
package com.sc.serviceimpl;

import com.alibaba.dubbo.config.annotation.Reference;
import com.sc.entity.StudyFile;
import com.sc.entity.User;
import com.sc.mapper.StudyFileMapper;
import com.sc.service.StudyFileService;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class StudyFileServiceImpl implements StudyFileService {

    @Autowired
    private StudyFileMapper studyFileMapper;
    @Reference //注解 注册中心引用服务
    private UserService userService;

    @Override
    public void addStudyFile(StudyFile studyFile) {
        studyFileMapper.addStudyFile(studyFile);
    }

    @Override
    public void deleteStudyFile(Integer studyfileId) {
        studyFileMapper.deleteStudyFile(studyfileId);
    }

    @Override
    public void updateStudyFile(StudyFile studyFile) {
        studyFileMapper.updateStudyFile(studyFile);
    }

    @Override
    public List<StudyFile> getAllStudyFile() {
        return studyFileMapper.getAllStudyFile();
    }

    @Override
    public List<StudyFile> getStudyFileByUser(Integer userId) {
        return studyFileMapper.getStudyFileByUser(userId);
    }

    @Override
    public StudyFile getStudyFileById(Integer studyfileId) {
        StudyFile studyFileById = studyFileMapper.getStudyFileById(studyfileId);
        User userById = userService.getUserById(studyFileById.getUserId());
        studyFileById.setUser(userById);
        return studyFileById;
    }

    @Override
    public List<StudyFile> getFileByType(Integer childtypeId) {
        return studyFileMapper.getFileByType(childtypeId);
    }

    @Override
    public List<StudyFile> getFileByStatus(Integer studyfileStatus) {
        return studyFileMapper.getFileByStatus(studyfileStatus);
    }

    @Override
    public List<StudyFile> getFileByMainType(Integer maintypeId) {
        return studyFileMapper.getFileByMainType(maintypeId);
    }

    @Override
    public List<StudyFile> getTodayFile(Integer studyfileStatus) {
        return studyFileMapper.getTodayFile(studyfileStatus);
    }

    @Override
    public List<StudyFile> searchPassFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchPassFile(studyfileName);
    }

    @Override
    public List<StudyFile> searchFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchFile(studyfileName);
    }

    @Override
    public List<Integer> getYearPerMonthFile() {
        return studyFileMapper.getYearPerMonthFile();
    }

}

//Application.java
package com.sc;

import com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan(value = "com.sc.mapper")
@EnableDubbo
public class BootFileServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(BootFileServiceApplication.class, args);
    }

}


//pom.xml
<dependency>
    <groupId>com.alibaba.boot</groupId>
    <artifactId>dubbo-spring-boot-starter</artifactId>
    <version>0.2.0</version>
</dependency>

//application.yml
spring:
  datasource:
    url: jdbc:mysql:///documents?useUnicode=true&characterEncoding=utf8&useSSL=false
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: root
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 100MB
server:
  port: 8081
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.sc.entity
  configuration:
    map-underscore-to-camel-case: true

dubbo:
  application:
    name: boot_file_service
  registry:
    address: zookeeper://127.0.0.1:2181

```

运行项目后可看到消费者成功添加入dubbo。并且可以看到文件信息中成功查询出用户信息
![8nqAOO.png](https://s1.ax1x.com/2020/03/13/8nqAOO.png)
![8nqeTH.png](https://s1.ax1x.com/2020/03/13/8nqeTH.png)

#### 启动时检查

- Dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线时，能及早发现问题，默认 check="true"。
- 可以通过 check="false" 关闭检查，比如，测试时，有些服务不关心，或者出现了循环依赖，必须有一方先启动。
- 另外，如果你的 Spring 容器是懒加载的，或者通过 API 编程延迟引用服务，请关闭 check，否则服务临时不可用时，会抛出异常，拿到 null 引用，如果 check="false"，总是会返回引用，当服务恢复时，能自动连上。
- 把需要关闭检查的服务都设置为不检查，就可以避免启动后查询数据报错，并且两个会自动连接

```java

//StudyFileServiceImpl.java
package com.sc.serviceimpl;

import com.alibaba.dubbo.config.annotation.Reference;
import com.sc.entity.StudyFile;
import com.sc.entity.User;
import com.sc.mapper.StudyFileMapper;
import com.sc.service.StudyFileService;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class StudyFileServiceImpl implements StudyFileService {

    @Autowired
    private StudyFileMapper studyFileMapper;
    @Reference(check = false) //注解 注册中心引用服务
    private UserService userService;

    @Override
    public void addStudyFile(StudyFile studyFile) {
        studyFileMapper.addStudyFile(studyFile);
    }

    @Override
    public void deleteStudyFile(Integer studyfileId) {
        studyFileMapper.deleteStudyFile(studyfileId);
    }

    @Override
    public void updateStudyFile(StudyFile studyFile) {
        studyFileMapper.updateStudyFile(studyFile);
    }

    @Override
    public List<StudyFile> getAllStudyFile() {
        return studyFileMapper.getAllStudyFile();
    }

    @Override
    public List<StudyFile> getStudyFileByUser(Integer userId) {
        return studyFileMapper.getStudyFileByUser(userId);
    }

    @Override
    public StudyFile getStudyFileById(Integer studyfileId) {
        StudyFile studyFileById = studyFileMapper.getStudyFileById(studyfileId);
        User userById = userService.getUserById(studyFileById.getUserId());
        studyFileById.setUser(userById);
        return studyFileById;
    }

    @Override
    public List<StudyFile> getFileByType(Integer childtypeId) {
        return studyFileMapper.getFileByType(childtypeId);
    }

    @Override
    public List<StudyFile> getFileByStatus(Integer studyfileStatus) {
        return studyFileMapper.getFileByStatus(studyfileStatus);
    }

    @Override
    public List<StudyFile> getFileByMainType(Integer maintypeId) {
        return studyFileMapper.getFileByMainType(maintypeId);
    }

    @Override
    public List<StudyFile> getTodayFile(Integer studyfileStatus) {
        return studyFileMapper.getTodayFile(studyfileStatus);
    }

    @Override
    public List<StudyFile> searchPassFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchPassFile(studyfileName);
    }

    @Override
    public List<StudyFile> searchFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchFile(studyfileName);
    }

    @Override
    public List<Integer> getYearPerMonthFile() {
        return studyFileMapper.getYearPerMonthFile();
    }

}

//UserServiceImpl.java
package com.sc.serviceimpl;

import com.alibaba.dubbo.config.annotation.Reference;
import com.sc.entity.StudyFile;
import com.sc.entity.User;
import com.sc.mapper.StudyFileMapper;
import com.sc.service.StudyFileService;
import com.sc.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class StudyFileServiceImpl implements StudyFileService {

    @Autowired
    private StudyFileMapper studyFileMapper;
    @Reference(check = false) //注解 注册中心引用服务
    private UserService userService;

    @Override
    public void addStudyFile(StudyFile studyFile) {
        studyFileMapper.addStudyFile(studyFile);
    }

    @Override
    public void deleteStudyFile(Integer studyfileId) {
        studyFileMapper.deleteStudyFile(studyfileId);
    }

    @Override
    public void updateStudyFile(StudyFile studyFile) {
        studyFileMapper.updateStudyFile(studyFile);
    }

    @Override
    public List<StudyFile> getAllStudyFile() {
        return studyFileMapper.getAllStudyFile();
    }

    @Override
    public List<StudyFile> getStudyFileByUser(Integer userId) {
        return studyFileMapper.getStudyFileByUser(userId);
    }

    @Override
    public StudyFile getStudyFileById(Integer studyfileId) {
        StudyFile studyFileById = studyFileMapper.getStudyFileById(studyfileId);
        User userById = userService.getUserById(studyFileById.getUserId());
        studyFileById.setUser(userById);
        return studyFileById;
    }

    @Override
    public List<StudyFile> getFileByType(Integer childtypeId) {
        return studyFileMapper.getFileByType(childtypeId);
    }

    @Override
    public List<StudyFile> getFileByStatus(Integer studyfileStatus) {
        return studyFileMapper.getFileByStatus(studyfileStatus);
    }

    @Override
    public List<StudyFile> getFileByMainType(Integer maintypeId) {
        return studyFileMapper.getFileByMainType(maintypeId);
    }

    @Override
    public List<StudyFile> getTodayFile(Integer studyfileStatus) {
        return studyFileMapper.getTodayFile(studyfileStatus);
    }

    @Override
    public List<StudyFile> searchPassFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchPassFile(studyfileName);
    }

    @Override
    public List<StudyFile> searchFile(String studyfileName) {
        if (studyfileName!=null && !studyfileName.equals(" "))
            studyfileName="%"+studyfileName+"%";
        else
            studyfileName=null;
        return studyFileMapper.searchFile(studyfileName);
    }

    @Override
    public List<Integer> getYearPerMonthFile() {
        return studyFileMapper.getYearPerMonthFile();
    }

}

```