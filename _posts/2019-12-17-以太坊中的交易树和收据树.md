---
layout:     post 
title:      以太坊
subtitle:   以太坊中的交易树和收据树
date:       2019-12-17
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 区块链
---

#### 交易树和收据树

- 交易树：每次发布一个区块的时候，区块中所包含的交易会组织成一个交易树，也是一颗Merkle Tree
- 收据树：每个交易执行完之后，会生成一个收据，记录这个交易的相关信息。也就是说交易树和收据树上面的节点是一一对应的。增加这个收据树主要是考虑到以太坊的智能合约的过程比较复杂，所以增加这个收据树的结构有利于我们快速查询一些执行的结果。
- 从数据结构上来说，交易树和收据树都是MPT。使用MPT的一个好处是：它支持查找操作，就是可以通过键值从顶向下沿着这棵树进行查找。对于状态树来说，查找的键值就是账户的地址；对于交易树和收据树来说，查找的键值就是交易在发布的区块中的序号，交易的排布顺序是由发布的区块决定的
- 交易树和收据树都是只把当前发布的区块里面的交易组织器来；而状态树是把系统中所有账户的状态组织起来，不管这些账户和当前区块的交易有没有关系
- 从数据结构上来说，多个区块的状态树是共享节点的，每次新发布一个区块的时候，只有这个区块中改变状态的那些节点需要新建一个分支，其他的节点只需要沿用原来状态树上的节点就可以了；而每个区块上的交易树和收据树都是独立的，他们是不会共享节点的。
- 交易树和收据树的作用：提供Merkle Proof：交易树可以用来证明某个交易是否被打包到某个区块中；收据树可以证明某个交易的执行结果

#### bloom filter

- bloom filter这个数据结构可以支持比较高效的查找某个元素是不是在一个比较大的集合里面
- 具体讲解：https://www.cnblogs.com/liyulong1982/p/6013002.html。这里不再描述
- 以太坊中的bloom filter：
   - 每个交易运行完之后会生成一个收据，这个收据就包含一个bloom filter，记录这个交易的类型、地址等其他信息。发布的区块在他的块头里也包含一个总的bloom filter，总的bloom filter是这个区块中所有bloom filter的并集
   - 假如你需要查找过去十天和某个智能合约相关的所有交易。查找的方法：先查找一下每个区块的块头中bloom filter有没有需要的交易类型。如果块头中没有的话，就代表整个区块就不是该交易类型的区块。如果有的话，再去查找这个区块包含的交易的收据树里面的bloom filter，如果有的话，再找到相对应的交易，直接进行确认。

#### 以太坊的运行过程

- 以太坊的运行过程可以把它看作是交易驱动的状态机（transaction-driven state machine）。
   - 状态机的状态指的是所有账户的状态，就是状态树中包含的内容
   - 交易指的是每次发布的区块中包含的那些交易。通过执行这些交易会驱动系统从当前状态转移到下一个状态

#### 代码中的结构

![](https://ftp.bmp.ovh/imgs/2019/12/2e656f81b4644747.jpg)
![](https://ftp.bmp.ovh/imgs/2019/12/c5b6ce09781008ab.jpg)
![](https://ftp.bmp.ovh/imgs/2019/12/41080805b5901745.jpg)
![](https://ftp.bmp.ovh/imgs/2019/12/b8b93b6a90880314.jpg)
![](https://ftp.bmp.ovh/imgs/2019/12/160672e49bf97ece.jpg)