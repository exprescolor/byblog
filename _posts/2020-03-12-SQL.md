---
layout:     post   				    # 使用的布局（不需要改）
title:       	SQL注入基础知识			# 标题 
#subtitle:   脚本，xss #副标题
date:       2020-03-12 				# 时间
author:     s-seven 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 学习 CTF
---

# SQL注入基础知识

上午完成了BasicPHP的两道题，又改了calculate那道，下午写完博客之后想看看BasicSQL,发现无从下手，那就先学一下基础知识吧！

##sqlmap

题目中提到了sqlmap这个工具，需要在python2下使用，python2和python3可以同时存在，可以把python2目录下的python.exe改成python2.exe，这样两个版本的命令就可以区分开了。然后下载sqlmap，解压之后放在python2的目录下面，像这样

![python2.jpg](http://ww1.sinaimg.cn/large/005KQQDely1gcrdbvce3tj30qn0dodgs.jpg)

然后在桌面创建一个快捷方式，重命名为sqlmap.exe，修改属性中的起始位置：

![1.jpg](http://ww1.sinaimg.cn/large/005KQQDely1gcrdf6gqqpj30fw0cs3z2.jpg)

打开exe，执行命令sqlmap.py -h进行安装，

![bug.jpg](http://ww1.sinaimg.cn/large/005KQQDely1gcrdfvx202j30xc08zwf2.jpg)

然后我出错了！！！上网查有人也出现了这种情况，但是没找到解决方案，于是我去Linux虚拟机下载

###几个常用的sqlmap命令

１、首先判断是GET 请求还是POST请求

2、GET请求，直接通过URL判断是否存在注入点

```
sqlmap -u url
```

3、查询出数据库名称

```
sqlmap -u url --current-db
```

4、查询出表名

```
sqlmap -u url -D 数据库名 --tables
```

5、查询字名

```
sqlmap -u url -D 数据库名 -T 表名 --columns
```

6、进行爆破

```
sqlmap -u url -D 数据库名 -T 表名 -C 列名,列名 --dump
```

## SQL注入基础知识

### 什么是sql注入

 	所谓SQL注入，就是通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令，比如先前的很多影视网站泄露VIP会员密码大多就是通过WEB表单递交查询字符暴出的，这类表单特别容易受到SQL注入式攻击．当应用程序使用输入内容来构造动态sql语句以访问数据库时，会发生sql注入攻击。如果代码使用存储过程，而这些存储过程作为包含未筛选的用户输入的字符串来传递，也会发生sql注入。 黑客通过SQL注入攻击可以拿到网站数据库的访问权限，之后他们就可以拿到网站数据库中所有的数据，恶意的黑客可以通过SQL注入功能篡改数据库中的数据甚至会把数据库中的数据毁坏掉。做为网络开发者的你对这种黑客行为恨之入骨，当然也有必要了解一下SQL注入这种功能方式的原理并学会如何通过代码来保护自己的网站数据库。

### sql注入产生的原因

​	sql注入攻击是利用是指利用设计上的漏洞，在目标服务器上运行Sql语句以及进行其他方式的攻击，动态生成Sql语句时没有对用户输入的数据进行验证是Sql注入攻击得逞的主要原因。对于Java数据库连接JDBC而言，SQL注入攻击只对Statement有效，对PreparedStatement是无效的，这是因为PreparedStatement不允许在不同的插入时间改变查询的逻辑结构。
​	如验证用户是否存在的SQL语句为：
​    用户名'and pswd='密码
​	如果在用户名字段中输入: 'or 1=1或是在密码字段中输入:'or 1=1
将绕过验证，但这种手段只对只对Statement有效，对PreparedStatement无效。相对Statement有以下优点：
​    1.防注入攻击
​    2.多次运行速度快
​    3.防止数据库缓冲区溢出
​    4.代码的可读性可维护性好
​    这四点使得PreparedStatement成为访问数据库的语句对象的首选，缺点是灵活性不够好，有些场合还是必须使用Statement。 

### SQL注入原理

​	SQL注射能使攻击者绕过认证机制，完全控制远程服务器上的数据库。 SQL是结构化查询语言的简称，它是访问数据库的事实标准。目前，大多数Web应用都使用SQL数据库来存放应用程序的数据。几乎所有的Web应用在后台 都使用某种SQL数据库。跟大多数语言一样，SQL语法允许数据库命令和用户数据混杂在一起的。如果开发人员不细心的话，用户数据就有可能被解释成命令， 这样的话，远程用户就不仅能向Web应用输入数据，而且还可以在数据库上执行任意命令了。
 	SQL注入式攻击的主要形式有两种。一是直接将代码插入到与SQL命令串联在一起并使得其以执行的用户输入变量。上面的例子就是采用了这种方法。由于其直接与SQL语句捆绑，故也被称为直接注入式攻击法。二是一种间接的攻击方法，它将恶意代码注入要在表中存储或者作为原书据存储的字符串。在存储的字符串中会连接到一个动态的SQL命令中，以执行一些恶意的SQL代码。注入过程的工作方式是提前终止文本字符串，然后追加一个新的命令。如以直接注入式攻击为例。就是在用户输入变量的时候，先用一个分号结束当前的语句。然后再插入一个恶意SQL语句即可。由于插入的命令可能在执行前追加其他字符串，因此攻击者常常用注释标记“—”来终止注入的字符串。执行时，系统会认为此后语句位注释，故后续的文本将被忽略，不背编译与执行。

### sql注入的攻击手段

​    ●判断应用程序是否存在注入漏洞

​    ●收集信息、并判断数据库类型

​    ●根据注入参数类型，重构SQL语句的原貌

​    ●猜解表名、字段名

​    ●获取账户信息、攻击web或为下一步攻击做准备

### sql注入的简单例子

1.SQL注入漏洞的几种判断方法
        ①http://www.xxxxxxx?id=40'
        ②http://www.xxxxxxx?id=40 and 1=1
        ③http://www.xxxxxxx?id=40 and 1=2
        如果执行①后，页面上提示报错或者提示数据库错误的话，说明是存在注入漏洞的。
        如果执行②后，页面正常显示，而执行③后，页面报错，那么说明这个页面是存在注入漏洞的。
2.收集信息、判断数据库类型
        从其返回的信息中可以判断下数据库的类型，更多可能可以知道部分数据库中的字段以及其他有用信息，为下一步攻击提供铺垫。
3.根据注入参数类型，重构SQL语句的原貌
        ①ID=40 这类注入的参数是数字型，那么SQL语句的原貌大致是：Select*from 表名 where 字段=40
        ②name=电影 这类注入的参数是字符型，SQL语句原貌大致是：Select*from 表名 where 字段=‘电影’
        ③搜索时没有过滤参数的，如keyword=关键字，SQL语句原貌大致是：Select*from 表名 where 字段 like ‘%关键字%’
4.猜解表名、字段名（直接将SQL语句添加到URL后）
        ①and exists(select*from 表名)
        如果页面没有任何变化，说明附加条件成立，那么就是说明猜解的表名正确，反之，就是不存在这个表，接下来就继续猜解，知道正确
        ②and exists（select 字段 from 表名）
        方法原理同上
        ③猜解字段内容（利用以上猜解出的表名和字段名 方法较古老且麻烦）
        ●猜解字段内容的长度
        （select top 1 len（字段名）from 表名）>0 直至猜解到>n不成立的时候，得出字段的长度为：n+1。
        ●得到长度后，猜解具体的内容
        （select top 1 asc（mid（username，1,1））from 表名）>0直到>m不成立时，就可以猜解出ASCII码值了。

## 判断是否存在注入点

### 加入单引号 ’提交
结果:如果出现错误提示，则该网站可能就存在注入漏洞。
### 数字型判断是否有注入
语句：and 1=1 ;and 1=2 （经典）、' and '1'=1(字符型）
结果:分别返回不同的页面,说明存在注入漏洞.
分析：and 的意思是“和”如果没有过滤我们的语句，and 1=1就会被代入SQL查询语句进行查询，
如果and前后的两条语句都是真的话就不会出错，但如果前后语句有一个为假的话，程序就会暴错。
也就表明程序有注入漏洞

防注入解决办法：
使用or 2>1 ; or 1>2来进行判断
结果:分别返回不同的页面,说明存在注入漏洞.
分析：or注入只要求前后两个语句只要有一个正确就为真，如果前后两个语句都是正确的，反而为
假。
注意：or注入时，or后面的语句如果是正确的，则返回错误页面！如果是错误，则返回正确页面
，说明存在注入点。
使用xor 1=1; xor 1=2
结果:分别返回不同的页面,说明存在注入漏洞.
分析:xor 代表着异或,意思即连接的表达式仅有一个为真的时候才为真。
注意：xor注入时，xor后面的语句如果是正确的，则返回错误页面积，如果是错误，则返回正确
页面，说明存在注入点。
把and 1=1转换成URL编码形式后在提交
and 1=1 URL编码：%41%4E%44%20%%31%3D%31
使用-1；-0
分析：如果返回的页面和前面不同，是另一则新闻，则表示有注入漏洞，是数字型的注入漏洞;在 
URL地址后面加上 -0，URL变成 news.asp?id=123-0，返回的页面和前面的
页面相同，加上-1，返回错误页面，则也表示存在注入漏洞.

### 字符型判断是否有注入

  语句：' and '1'=1；' and  '1=2(经典）
  结果：结果:分别返回不同的页面,说明存在注入漏洞.
  分析：加入' and '1'=1返回正确页面，加入' and  '1=2返回错误页面，说明有注入漏同。
  防注入解决办法：
  在URL的地址后面加上'%2B'（字符型）
  分析：URL地址变为：news.asp?id=123'%2B'，返回的页面和1同;加
上'2%2B'asdf，URL地址变为：news.asp?id=123'%2Basdf，返回的页面和1
不同，或者说未发现该条记录，或者错误，则表示存在注入点，是文本型的。

### 搜索型判断是否有注入

简单的判断搜索型注入漏洞存在不存在的办法是先搜索'，如果出错，说明90%存在这个漏洞。然后搜
索%，如果正常返回，说明95%有洞了。
说明：加入如"&;"、"["、"]"、"%"、"$"、"@"等特殊字符，都可以实现，如果出现错误，说明有问题
操作：
搜索一个关键字，比如2006吧，正常返回所有2006相关的信息，再搜索2006%'and 1=1 and '%'='和
2006%'and 1=2 and '%'='，存在异同的话，就是100%有洞了。
关键字%' and 1=1 and '%'='%
关键字%' and 1=2 and '%'='%
将and 1=1 换成注入语句就可以了

## 近日小结

最大的问题是写博习惯和时间安排

这几天每次都是做完题到了晚上开始写博，很多时候白天一天看的知识都忘了或者忘了写了，经过一天之后再回来想这道题，在思路和分析上就没有当时那么完整了，以后要养成学习就开博，把博客当成笔记来写，尽可能内容完善。

第二个问题就是时间安排，前些日子太过放松，现在有事情之后一时间乱了手脚，下午的效率不是很高，一会要合理安排时间，把容易集中精力的事情放在下午做。

两三天之后感觉容易点的题目做的差不多了，现学现卖的方法在以后可能就不适用了，后面的题需要多查阅资料，不同类型的题要多分析方法和思路，不能只局限在做出来，基础知识一定要掌握。

后面几天也要穿插着复习一下基础知识，比如编译原理（这个几乎全忘了），汇编原理，体系结构等