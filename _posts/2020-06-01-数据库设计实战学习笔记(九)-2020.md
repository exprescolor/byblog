---
layout:     post                        # 使用的布局（不需要改）
title:      数据库设计实战学习笔记(九)              # 标题
subtitle:     # 副标题
date:       2020-06-01                  # 时间
author:     AhogeK                      # 作者
header-img:  https://tr3.cbsistatic.com/hub/i/r/2016/08/02/ffb48ac0-b355-4aec-b814-04c79e1e1bfd/resize/1200x/292c4adbf288356b843876804b244d69/mysqlhero.jpg    # 这篇文章标题背景图片
catalog: true                           # 是否归档
tags:                                   # 标签
    - MySQL
    - 慕课学习笔记
---
### MyCat双机热备方案
> 只有双机热备的MyCat方案才具有高可用性
![HotStandby](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-06-01%2006-10-08.png)

#### 配置虚拟IP的前提条件
* 虚拟IP只支持局域网，不可以在公网设置虚拟IP
* 云主机无法设置虚拟IP
* Windows系统和MacOS系统都无法设置虚拟IP，必须是Linux系统
* 公司网络跟移动热点网络环境下，都不能设置虚拟IP

#### 正确设置虚拟IP的环境
* 在Vmware虚拟机上面设置桥街网络（必须）
* 使用家用路由器的网络环境（连接网线最好，WIFI次之）

#### Keepalived工作原理
* Keepalived基于VRRP协议，可以预防单点故障
* VRRP协议将多个服务节点组成一个网络，里面有一个Master和若干个Backup节点
* Master会发送VRRP广播，如果Backup节点收不到广播，就认为Master节点宕机了。Backup节点会选举处一个新的Master节点

#### 让防火墙支持VRRP协议
* 开启防火墙，让CentOS支持VRRP协议

```
firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT
firewall-cmd --reload
```

#### 虚拟IP地址
* 在Linux系统中可以在网卡设备中设置多个IP地址，已达到为不同程序分配一个独立的IP地址，这种IP地址被称为虚拟IP

#### 安装Keepalived
* 进入到MyCat容器，执行下面的命令，安装Keepalived程序
  * ```
    apt-get update
    apt-get install keepalived
    ```
* Keepalived的配置文件是/etc/keepalived/keepalived.conf

#### Keepalived配置文件
![KeepalivedConfigFile](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-06-01%2006-31-14.png)

* **state** 
  * Keepalived的身份(MASTER主服务，BACKUP备服务器)。主服务要抢占虚拟IP，备用服务不会抢占虚拟IP
* **interface**
  * 网卡设备
* **virtual_router_id**
  * 虚拟路由标识，MASTER和BACKUP的虚拟路由标识必须一致。标识可以是0～255
* **priority**
  * MASTER权重要高于BACKUP，数字越大优先级越高
* **advert_int**
  * MASTER与BACKUP节点间同步检查的时间间隔，单位为秒。主备之间必须一致。
* **authentication**
  * 主从服务器验证方式。主备必须使用相同的密码才能正常通信。
* **virtual_ipaddress**
  * 虚拟IP地址，可以设置多个虚拟IP地址，每行一个。

启动Keepalived: ``service keepalived start``

必须为两个MyCat容器成功配置Keepalived才算双机热备方案

Swarm网络内的虚拟IP无法被外网访问，所以徐哟呵把虚拟IP映射到外网

**主机虚拟IP（192.168.50.151）** --> **Keepalived** --> **Swarm虚拟IP（172.18.0.201）** 

#### 配置宿主机Keepalived
![HostKeepalived](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-06-01%2007-09-20.png)

### 使用Portainer管理Docker
#### 开放Docker网络管理端口
* 安装Portainer之前必须要先开放Docker网络管理端口
  * ``vi /etc/sysconfig/docker``
* 在配置文件结尾添加开放Docker 2375 端口
  * ``OPTIONS='-Htcp://0.0.0.0:2375 -H unix:///var/run/docker.sock'``
* 开启2375防火墙端口
  * ``firewall-cmd --zone=public --add-port=2375/tcp --permanent``

#### 安装Portainer
* 下载镜像并创建出Portainer容器

```
docker pull portainer/portainer
docker run -d -p 9000:9000 -name portainer portainer/portainer -H tcp://192.168.50.120:2375
```

### Binlog日志文件的重要性
#### binlog日志文件
* binlog日志文件记录了MySQL执行的所有操作，以及执行SQL语句消耗的时间
* 默认情况下，binlog日志功能是关闭的

#### 开启binlog日志
* 修改mysql配置文件，加上log_bin参数，然后重新启动MySQL服务
  * ``log_bin = mysql_bin``

#### 误删除数据的闪回
* 执行了错误的SQL语句，误删除了记录，即便事务已经提交，但是依然可以找回数据，但是业务系统必须要停机。
* 使用Python程序从binlog日志中提取SQL语句，然后找到剔除错误的SQL语句，重新执行binlog日志中的SQL即可

### 主从同步原理
> 从节点把主节点binlog日志复制到本地，然后执行日志中的SQL语句，从而实现数据同步

#### 一主多从架构
* 通常来说，业务系统都是读多写少，所以可以给主节点配置更多的从节点

#### 从节点分发数据
* 如果从节点过多，会消耗主节点的网络资源，导致数据同步变慢
* 可以通过从节点分发数据，提升数据同步速度

#### 双主节点相互同步
* 为了实现主节点高可用，可以配置双主节点的集群

#### 安装MySQL镜像
* 建议Replication集群使用5.7版本的MySQL
  * ```
    docker pull mysql:5.7.27
    docker tag mysql:5.7.27 mysql
    docker rmi mysql:5.7.27
    ```

#### 创建MySQL容器

``docker run -d -p 9003:3306 --name rn1 -e MYSQL_ROOT_PASSWORD=123456 -v rnv1:/var/lib/mysql --privileged --net=swarm_mysql mysql``

### 高可用Replication集群
#### 第一组Replication集群
![FirstReplication](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-06-01%2021-58-57.png)

#### 创建同步账户
* 从节点需要先登录到主节点，然后才可以复制binlog日志，所以我们要在主节点上创建一个用于数据同步的账户
* 因为root不允许远程登录，所以从节点不能用root账户访问主节点

#### 配置主节点
* 修改 /etc/mysql/my.cnf 配置文件，加上下面的参数

```
[mysqld]
character_set_server = utf8
server_id = 1001
log_bin = mysql_bin
relay_log = relay_bin
log-slave-updates = 1
sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
```

#### 配置从节点
* 修改 /etc/mysql/my.cnf 配置文件，加上下面的参数
  
```
[mysqld]
character_set_server = utf8
server_id = 1002
log_bin = mysql_bin
relay_log = relay_bin
read-only = 1
```

#### 设置主从同步
* 在从节点上面，执行下面三条SQL语句，就能实现数据同步

```sql
stop slave;
change master to master_host='rn1',master_port=3306,master_user='backup',master_password='123456';
start slave;
```

#### 检测主从同步状态
* 在从节点上面执行以下SQL语句，如果能看到Slave_IO_Running,Slave_SQL_Running两个YES代表主从同步成功
  * ``show slave status;``