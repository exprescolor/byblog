---
layout:     post 
title:      区块链
subtitle:   比特币分叉
date:       2019-12-09
author:     张鹏
header-img: img/home-bg.jpg
catalog: true   
tags:                         
    - 区块链
---

#### 比特币系统中的分叉

- 原来是一条链，现在分成了两条链，这就叫做分叉（fork）
   - 分叉可能是多种原因造成的。比如之前写到的：挖矿的时候，如果有两个节点差不多同一时候挖到了矿，那么这时候两个节点都可以发布区块，这时候就会出现临时性的分叉。我们把这样的分叉叫做state fork
      - state fork：由于对比特币这个区块链当前的状态有分歧而造成的分叉
      - forking attack（分叉攻击）：也属于state fork，也是属于对比特币这个区块链当前的状态产生了分歧。只不过分叉攻击中的意见分歧是故意造成的。所以有时候把它叫做deliberate fork
   - 还有一种产生分叉的情况是比特币协议发生了变化。要修改比特币协议需要进行软件升级，在一个去中心化的系统里，升级软件的时候没有办法保证所有的节点同时都升级软件。这种分叉叫做protocal fork。
      - protocal fork：因为对比特币协议产生了分歧，用不同版本的协议造成了分叉。根据对协议修改的内容的把不同，又可以进一步分为**硬分叉（hard fork）和软分叉（soft fork）**

#### 硬分叉

- 如果对比特币协议增加一些新的特性，拓展一些新的功能，这时候那些没有升级软件的旧节点他是不认可这些新特性的，认为这些特性是非法的。这时候就是对比特币协议的内容产生了意见分歧，就会导致分叉
- 具体的一个例子：比特币当中的区块大小限制（block size limit）、
   - 比特币规定一个区块最多是1Mb大小，有些人认为1Mb的限制太小了，影响了比特币的交易速度。假设有人发布了软件更新，把区块大小从1Mb改为4Mb，假设大多数节点更新了这个软件。那么新节点就会按照大小限制为4Mb进行挖矿操作，，但是旧的节点不认同新节点的大小限制，仍然继续按照原来的节点向下挖矿，这样就造成了永久的分叉，只要旧节点不升级软件，分叉就一直存在
   - <img src="https://vi0.xiu123.cn/live/2019/12/09/10/1003v1575857903747980890.jpg" style="zoom:80%;" />
- 硬分叉的特点是只有系统中所有的节点都更新了版本才能避免产生永久性的分叉，如果有小部分节点不愿意更新，那么这个系统就会分成两条链

#### 软分叉

- 如果对比特币协议加一些限制，那么原来的一些交易或者区块在这个新的协议中可能不是合法的，就会引起软分叉
   - 假设把区块限制更改为0.5Mb，那么新节点就不会认可大小限制为1Mb的旧节点，会沿着新节点挖出的区块进行挖矿操作，但是旧节点是认可新节点的大小限制的，所以旧节点也会沿着新节点来进行挖矿操作。旧节点原来的区块就会被舍弃，因为他不再是最长合法链。这样系统不会存在永久性的分叉

##### 实际当中可能出现软分叉的情况

- 1.给某些目前协议中没有规定的域增加一些新的含义，赋予他们一些新的规则。其中一个例子就是coinbase域（每个发布的区块里有一个铸币交易coinbase transaction，它里面有一个域叫做coinbase域，这个域用来干什么没人规定，也没人检查。他的一个作用是在调整挖矿难度的时候可以把coinbase的前八个字节作为extra nonce）
   - 但是coinbase域不止8个字节，后面还有很多，那么有人就提出把后面的字节作为UTXO集合的根哈希值
- 2.P2SH：Pay To Script Hash
- 软分叉的特点：系统中只需要有半数以上的节点升级了新的版本，就不会产生永久性的分叉

#### 具体问题讲解

- **1.转账交易的时候如果具体的接收者不在线怎么办？**
   - 这个时候并不需要接收者在线。转账交易只不过是要在区块链上记录一下比特币的流向，对方当时是否连接在比特币网络里是没有影响的

- **2.假设一个全节点收到了一个转账交易，有没有可能转账交易中接收者的收款地址是这个节点以前从来没有听说过的？**
   - 这是可能的。比特币账户在创建的时候是不需要通知其他人的，在本地产生一个公私钥对就可以了，只有在以后产生的收款地址第一次收到钱的时候，其他节点才知道这个账户的存在

- **3.如果账户的私钥丢失了怎么办？**
   - 私钥丢失之后是没有办法的，这个账户就彻底作废了

- **4.如果私钥泄露了怎么办？**
   - 应该尽快把账户上的钱转移到另外一个账户中

- **5.Proof of Burn语句中既然无论如何返回都是false，那么交易信息是怎么写入到区块链中的？**
   - 这个语句是写在当前交易的输出脚本里的，所以验证当前交易合法性的时候不会执行这个语句。当前交易的输出脚本在验证当前交易合法性的时候是不会被执行的。只有后面又有一个交易想要花当前交易的输出的时候才会被执行。

- **6.如何判断是哪一个矿工最先找到合法的区块？**
   - 发布的区块中有一个coinbase transaction，里面有一个收款人地址，如果有人想要修改别人发布的区块来变成自己的区块，那么他就要修改这个收款人地址，但是这个地址变了之后，那么整个coinbase transaction的内容就会发生改变，就会导致Merkle Tree的根哈希值发生变化

- **7.如何判断交易费该给哪一个矿工？**
   - 事先并不需要知道哪一个矿工会得到交易费。只要交易的总输入大于总输出，那么只要有交易产生之后，系统就会自动把两者的差值作为交易费发给挖到矿的矿工