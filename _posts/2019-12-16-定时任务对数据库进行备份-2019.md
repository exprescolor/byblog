---
layout:     post                        # 使用的布局（不需要改）
title:      定时任务/mysql备份              # 标题
subtitle:   Spring-Boot
date:       2019-12-16                # 时间
author:     AhogeK                      # 作者
header-img: img/post-bg-android.jpg     # 这篇文章标题背景图片
catalog: true                           # 是否归档
tags:                                   # 标签
    - 学习笔记
    - 工作记录
---
Spring Boot启动类添加 @EnableScheduling 注解

```java
@EnableScheduling
@SpringBootApplication(scanBasePackages = {"io.ahogek.common","io.ahogek.system"})
public class SystemApplication {

    public static void main(String[] args) {
        SpringApplication.run(SystemApplication.class, args);
    }

}
```

在业务层写 定时任务
```java
@Autowired
private DataBaseInfoConfig dataBaseInfo;

/**
 * 定时任务，定时检测数据的日志是否积攒超过半年
 *
 */
@Scheduled(cron = "*/5 * * * * ?")
public void cronJob() {
    List<SysOperLog> sysOperLogList = list(new QueryWrapper<SysOperLog>().lambda().orderByDesc(SysOperLog::getUpdateBy));
    // 获取最新及最旧的数据
    if (sysOperLogList.size() > 1) {
        SysOperLog topEntity = sysOperLogList.get(0);
        SysOperLog bottomEntity = sysOperLogList.get(sysOperLogList.size() - 1);
        long from = bottomEntity.getCreateDate().getTime();
        long to = topEntity.getUpdateDate().getTime();
        // 判断是否已过半年
        if ((int) ((to - from) / (ONE_SECOND_OF_NANO * ONE_MINUTE_OF_SECOND * ONE_MINUTE_OF_SECOND * ONE_DAY_OF_HOUR)) >=
                (LocalDate.now().isLeapYear() ? (LEAP_YEAR_DAYS / HALF) : (NORMAL_YEAR_DAYS / HALF))) {
            String hostIp = dataBaseInfo.getHostIp();
            Map<String, String> ipAddressMap = getIpAndPort(hostIp);
            String path = this.getClass().getProtectionDomain().getCodeSource().getLocation().getPath();
            File file = new File(path);
            // windows开发用
            // path = file.getParent().substring(path.indexOf("/"), file.getParent().lastIndexOf("\\"));
            // path = path.substring(0, path.lastIndexOf("\\"));
            path = file.getParent().substring(0, file.getParent().lastIndexOf("/"));
            try {
                MySqlDatabaseBackupUtil.exportDatabaseTool(ipAddressMap.get("ip"), ipAddressMap.get("port"),
                        dataBaseInfo.getUserName(), dataBaseInfo.getPassword(), path, LocalDate.now() + ".sql");
            } catch (InterruptedException e) {
                e.printStackTrace();
                throw new SysException(SysExceptionEnum.LOG_SAVE_ERROR);
            }
            // 对所有旧数据进行删除
            if (!remove(new QueryWrapper<>())) {
                throw new SysException(SysExceptionEnum.DATA_DELETION_EXCEPTION);
            }
        }
    }
}

/**
 * 解析配置文件中的地址，获取ip及端口存入map返回
 *
 * @param hostIp 配置中的数据库地址
 * @return 数据库地址信息
 */
private Map<String, String> getIpAndPort(String hostIp) {
    Map<String, String> map = new HashMap<>(255);
    int start = hostIp.indexOf("/") + 2;
    hostIp = hostIp.substring(start);
    int end = hostIp.indexOf("/");
    hostIp = hostIp.substring(0, end);
    int index = hostIp.indexOf(":");
    String ip = hostIp.substring(0, index);
    map.put("ip", ip);
    String port = hostIp.substring(index + 1);
    map.put("port", port);
    return map;
}
```

当中读取 config 配置文件中数据库数据的配置文件类，通过 @Autowired 注入

```java
@Component
@Data
public class DataBaseInfoConfig {

    @Value("${spring.datasource.username}")
    private String userName;

    @Value("${spring.datasource.password}")
    private String password;

    @Value("${spring.datasource.url}")
    private String hostIp;
}
```

以及对数据库进行备份的工具类

```java
public class MySqlDatabaseBackupUtil {
    /**
     * Java代码实现MySQL数据库导出
     *
     * @param ip MySQL数据库所在服务器地址IP
     * @param userName 进入数据库所需要的用户名
     * @param password 进入数据库所需要的密码
     * @param savePath 数据库导出文件保存路径
     * @param fileName 数据库导出文件文件名
     */
    public static void exportDatabaseTool(String ip, String port, String userName, String password, String savePath, String fileName) throws InterruptedException {
        File saveFile = new File(savePath);
        // 如果目录不存在
        if (!saveFile.exists()) {
            // 创建文件夹
            saveFile.mkdirs();
        }
        // 查看你路径最后是否已 / 结尾
        if(!savePath.endsWith(File.separator)){
            savePath = savePath + File.separator;
        }
        PrintWriter printWriter = null;
        BufferedReader bufferedReader = null;
        try {
            printWriter = new PrintWriter(new OutputStreamWriter(new FileOutputStream(savePath + fileName), "utf8"));
            String[] execCmd = new String[]{"mysqldump", "-h" + ip, "-P" + port, "-u" + userName, "-p" + password, "--set-charset=UTF8", "sx_system", "sys_oper_log"};
            Process process = Runtime.getRuntime().exec(execCmd);
            InputStreamReader inputStreamReader = new InputStreamReader(process.getInputStream(), "utf8");
            bufferedReader = new BufferedReader(inputStreamReader);
            String line;
            while((line = bufferedReader.readLine())!= null){
                printWriter.println(line);
            }
            printWriter.flush();

            //0 表示线程正常终止。
            if(process.waitFor() == 0){
            }
        }catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                if (bufferedReader != null) {
                    bufferedReader.close();
                }
                if (printWriter != null) {
                    printWriter.close();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
```