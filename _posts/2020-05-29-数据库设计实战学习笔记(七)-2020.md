---
layout:     post                        # 使用的布局（不需要改）
title:      数据库设计实战学习笔记(七)              # 标题
subtitle:   新零售平台的数据库集群  # 副标题
date:       2020-05-29                  # 时间
author:     AhogeK                      # 作者
header-img:  https://tr3.cbsistatic.com/hub/i/r/2016/08/02/ffb48ac0-b355-4aec-b814-04c79e1e1bfd/resize/1200x/292c4adbf288356b843876804b244d69/mysqlhero.jpg    # 这篇文章标题背景图片
catalog: true                           # 是否归档
tags:                                   # 标签
    - MySQL
    - 慕课学习笔记
---
### 数据库集群能解决什么问题？
#### 单节点和集群哪个读写更快
* 低并发情况下，单节点MySQL读写速度快
* 高并发情况下，MySQL集群的读写速度更快

集群一般有两个方案
* 读写分离方案
  * 即写操作与读操作分别一个数据库DB，但两个DB之间需要进行数据同步
* 数据切分方案
  * 即切割多个数据库DB存放不同的数据，这里各个DB之间不能进行数据同步

#### 单节点数据库的弊病
* 大型互联网程序用户群体庞大，所以架构必须要特殊设计
* 单节点的数据库无法满足性能上的要求
* 单节点的数据库没有冗余设计，无法满足高可用

#### 常见MySQL集群方案
* 常见的MySQL集群方案有PXC（同步）和Replication（异步）
* 两种集群方案有各自的特点，PXC集群适合保存少量高价值数据，Replication集群适合保存大量数据

### 如何使用Docker虚拟机
#### Docker与VM虚拟机对比
* Docker是免费的虚拟机引擎，可以为任何应用创建一个轻量级的、可移植的容器

> VM虚拟机创建的是完整的虚拟系统，所以对占用硬件较高，属于重量级虚拟机
> Docker虚拟机创建的虚拟实例共用同一个系统内核，对硬件占用较小，属于轻量级虚拟机

#### Docker镜像
* Docker虚拟机的镜像是一个只读层，不能写入数据
* 可以通过dockerfile文件，定义需要安装的程序，然后创建出镜像文件

#### Docker容器
* Docker容器是一个虚拟的实例，里面的内容可读可写
* 容器是完全隔离的，我们不用担心部署程序会相互干扰
* 一个镜像可以创建出多个容器

#### 安装Docker虚拟机
* 在CentOS上安装Docker虚拟机
  * ```shell
    yum install -y docker
    service docker start
    service docker stop
    ```

#### Docker虚拟机管理命令
![dockercommend](https://ahogek-oss.oss-cn-hangzhou.aliyuncs.com/blog-img/Screenshot%20from%202020-05-29%2005-12-51.png)

#### 设置镜像加速
* 使用DockerCloud，提高镜像下载速度
  * ``curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io``
* 编辑 /etc/docker/daemon.json 文件，把结尾的逗号去掉

#### 简单的使用
```shell
docker search java
docker pull docker.io/openjdk
docker run -it -v /root/java:/root/java docker.io/openjdk bash
```

#### 镜像的导入与导出
* Docker中的镜像可以随时导出与导入
  * ```shell
    docker save -o /root/openjdk.tar.gz docker.io/openjdk
    docker load < /root/openjdk.tar.gz
    ```

#### 创建容器
* 创建容器的时候，我们可以映射端口和挂载目录
  * ```shell
    docker run -it --name java openjdk bash
    docker run -it --name java -p9000:8080 -p9001:8085 openjdk bash
    docker run -it --name java -v /root/project:/soft --privileged
    ```

### 分布式Docker环境
#### 集中部署的缺点
* 把数据库集群都部署在一个Docker上，如果宿主机宕机，会导致每个MySQL节点都无法使用

#### 分布式部署
* Docker Swarm技术可以自动把异地的Docker虚拟机组成一个局域网
**注**：*创建Swarm集群后，不要更换网络，否则会导致Swarm集群失效，另外虚拟机必须要设置成桥街网络*

#### 创建多个VM实例
#### 创建Swarm集群
在多个Docker虚拟机中选其中之一执行``docker swarm init``以此来创建Swarm集群

#### 查看Swarm集群节点
```shell
docker node ls
docker node rm -f 节点
docker swarm leave -f (主节点上运行，被删除的节点的主机上也需要进行leave，才可以加入新的swarm)
```

#### 查看Swarm集群网络
``docker network ls``

#### 创建共享网络
``docker network create -d overlay --attachable swarm_test``

**只能在Manager节点管理虚拟网络，在Worker节点上既看不到虚拟网络，也无法管理虚拟网络**

删除虚拟网络：``docker network rm swarm_test``

#### 创建分布式容器
``docker run -it --net=swarm_test ...``

### 搭建PXC集群
#### PXC集群介绍
* Pecona XtraDB Cluster 是业界主流的MySQL集群方案
* PXC集群的数据同步具有强一致性的特点
* PXC集群只支持InnoDB引擎

#### 开启防火墙端口
* 开启2377、7946和4789端口，重启Docker服务
  * ```shell
    firewall-cmd --zone=public --add-port=2377/tcp --permanent
    firewall-cmd --zone=public --add-port=7946/tcp --permanent
    firewall-cmd --zone=public --add-port=7946/udp --permanent
    firewall-cmd --zone=public --add-port=4789/tcp --permanent
    firewall-cmd --zone=public --add-port=4789/udp --permanent
    firewall-cmd --reload
    ```
**必须要开启防火墙端口，每个虚拟机节点都要开放Swarm集群的三个端口，reload防火墙之后，还要重启每个节点的Docker服务，然后才能创建PXC容器，否则就会出现因为防火墙的原因导致从节点无法连接主节点容器**

#### 下载PXC镜像
* 下载安装最新的PXC镜像
  * ```shell
    docker pull percona/percona-xtradb-cluster
    docker tag percona/percona-xtradb-cluster pxc
    docker rmi percona/percona-xtradb-cluster
    ```
      * 建议下载 5.7.21版本 ---> docker pull percona/percona-xtradb-cluster:5.7.21
* [https://hub.docker.com/r/percona/percona-xtradb-cluster](https://hub.docker.com/r/percona/percona-xtradb-cluster)

#### PXC的主节点容器
* 第一个启动的PXC节点是主节点，它要初始化PXC集群
* PXC启动之后，就没有主节点的角色
* PXC集群中任何节点都是可以读写数据

#### 创建主节点容器
* 创建主节点之后，稍等一会才可以连接
```shell
docker run -d -p 9001:3306 -e MYSQL_ROOT_PASSWORD=123456 -e CLUSTER_NAME=PXC1 -e XTRABACKUP_PASSWORD=123456 -v pnv1:/var/lib/mysql --privileged --name=pn1 --net=swarm_mysql pxc
```

#### 创建从节点
* 必须主节点可以访问才能创建从节点，否则会闪退
  * ```
    docker run -d -p 9001:3306 -e MYSQL_ROOT_PASSWORD=123456 -e CLUSTER_NAME=PXC1 -e XTRABACKUP_PASSWORD=123456 -e CLUSTER_JOIN=pn1 -v pnv2:/var/lib/mysql --privileged --name=pn2 --net=swarm_mysql pxc
    ```

### 管理Docker数据卷
#### 什么是数据卷？
* 数据卷相当于给容器挂载了一个虚拟的磁盘

#### 管理数据卷
```
docker volume ls #数据卷列表
docker volume create test #创建数据卷
docker volume rm test #删除数据卷
docker volume prune #清除没有挂载的数据卷
docker volume inspect pnv1 #查看数据卷详情
```

### PXC集群的注意事项
#### 从节点启动后闪退
* 如果主节点没有完全启动成功，从节点就会闪退
* PXC最后退出的节点要最先启动，而且要按照主节点启动
* Docker不能更换容器启动命令，所以B节点无法按照主节点启动
* 修改grastate.dat文件，把safe_to_bootstrap参数改为0
  * ``safe_to_bootstrap = 0``
* safe_to_bootstrap等于1，代表该节点是最后退出的节点，需要按照主节点启动

#### 主节点启动后闪退
* PXC启动之后，所有节点的safe_to_bootstrap都是0
  * 如果所有PXC节点同时意外关闭，所有节点safe_boot_strap都是0，所以主节点无法启动
* 如果PXC集群正在运行，宕机的主节点不能按照主节点启动
  * 删除容器，检查safe_to_bootstrap是否为0
  * 以从节点方式创建容器，加入集群

#### 加入PXC集群的注意事项
* 可以使用任何PXC节点，然后从节点加入PXC集群
* 重启从节点，必须保证其主节点可以访问的状态

### 搭建PXC集群分片
#### PXC集群的特点
* PXC节点之间，数据同步是双向，而且是强一致性的

#### 数据同步带来的问题
* 无论在哪个节点写入数据，最终所有节点的数据都是相同的
* 为了实现数据切分的效果，我们必须新组建一个PXC集群

### 搭建Replication集群
#### Replication集群简介
* Replication集群是MySQL自带的数据同步机制
* MySQL通过读取、执行另一个MySQL的bin_log日志，实现数据同步

#### 主从同步关系
* Replication集群中，数据同步是单向的，从主节点（Master）同步到从节点（Slave）

#### 下载安装Replication镜像
* Oracle并没有提供官方的Replication镜像，所以我们只能安装第三方封装的镜像文件

```
docker pull mishamx/mysql
docker tag mishamx/mysql rep
docker rmi mishamx/mysql
```

#### 创建主节点容器
* 主节点用来让其他节点与之同步，而且主节点身份是固定的

```
docker run -d -p 9003:3306 --name rn1 -e MYSQL_MASTER_PORT=3306 -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_REPLICATION_USER=backup -e MYSQL_REPLICATION_PASSWORD=123456 -v rnv1:/var/lib/mysql --privileged --net=swarm_mysql rep
```

#### 创建从节点容器
* 从节点需要与主节点同步数据，没有主节点不能创建从节点
```
docker run -d -p 9003:3306 --name rn2 -e MYSQL_MASTER_HOST=rn1 -e MYSQL_MASTER_PORT=3306 -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_REPLICATION_USER=backup -e MYSQL_REPLICATION_PASSWORD=123456 -v rnv2:/var/lib/mysql --privileged --net=swarm_mysql rep
```

### Replication集群的注意事项
#### 主节点关闭，从节点会发生什么？
* 主节点关闭，从节点依然可以使用，但主从同步机制会因此而失效

#### 不启动主节点，从节点能启动吗？
* 不启动主节点，从节点也能启动，主从同步失效

### 搭建Replication集群分片
#### 强一致性与弱一致性
* PXC是强一致集群，Replication是弱一致性集群

