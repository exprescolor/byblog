<html>
<style type="text/css">
    .divcss5 {
        text-indent: 15px;
        font-weight: bold
    }
    html, body {
        height: 100%;
        overflow: hidden;
    }
    iframe {
        margin: 0;
        /*border-style: none;*/
        width: 100%;
        height: 100%;
    }
</style>

<div>
    <br>
    <form action="/test_nodejs_api" method="get">
        country(*): <input type="text" id="country" value="US"/>
        language(*): <input type="text" id="language" value="en"/>
        currency(*): <input type="text" id="currency" value="en"/>
        <br>
        product code: <input type="text" id="code"/>
        mode(*):
        <select id="mode">
            <option value="cto">cto</option>
            <option value="lfo">lfo</option>
            <option value="lfo-as-cto">lfo-as-cto</option>
        </select>
        <br>
        site:
        <select id="site_select">
            <option value="非集成"></option>
            <option value="ecomm">ecomm</option>
            <option value="lbp">lbp</option>
            <option value="crm">crm</option>
            <option value="lms">lms</option>
        </select>
        role:
        <input type="text" name="role"/>

        <input class="divcss5" type="button" name="mock_integration" value="回车执行" id="partRefresh">
    </form>
    <p>
        实际访问的地址: <input type="text" id="final_url" disabled="disabled" value="" size="130"/>
    </p>
</div>

<iframe name="iframe_dcsc" id="iframe_dcsc_id" width="1200" height="500"
        src='https://us-dcsc.lenovo.com/#/?country=US'
        frameborder="1" allowfullscreen></iframe>

<script src="../js/jquery.min.js "></script>

<script>
    $(function () {
        $("#final_url").attr("value", $("#iframe_dcsc_id").attr("src"));
    })

    $(document).keyup(function (event) {
        if (event.keyCode == 13) {
            $("#partRefresh").trigger("click");
        }
    });
</script>
<script type="text/javascript">

    const partRefreshBtn = document.getElementById("partRefresh");
    partRefreshBtn.onclick = function () {
        let code = $("#code").val();
        let site = $("#site_select").val();
        let country = $('#country').val();
        let language = $('#language').val();
        let currency = $('#currency').val();

        let finalUrl = "";

        let param = '?time=' + new Date().getTime() + '&country=' + country + '&language=' + language + '&currency=' + currency;
        if (site === 'ecomm') {
            param += '&token=ecomm';
        } else if (site === 'lms') {
            param += '&token=LMS_BP';
        } else if (site === 'lbp') {
            param += '&token=LBP_T1_D_B';
        } else if (site === 'lbp') {
            param += '&token=LBP_T1_D_B';
        }

        if (code == null || code == '') {
            finalUrl = 'https://us-dcsc.lenovo.com/#/' + param;
        } else {
            if ($("#mode").val() == 'lfo') {
                finalUrl = 'https://us-dcsc.lenovo.com/#/configuration/lfo/' + code + param + '&mode=lfo';
            } else {
                finalUrl = 'https://us-dcsc.lenovo.com/#/configuration/' + $("#mode").val() + '/' + code + param;
            }
        }
        // $("#iframe_dcsc_id").attr("src", finalUrl);
        refreshIframeByCreateNew(finalUrl);
        console.log(finalUrl);
        $("#final_url").attr("value", finalUrl);
    }


    function refreshIframeByCreateNew(url) {
        destroyIframe('iframe_dcsc_id')
        let newIframe = document.createElement("iframe");
        newIframe.id = 'iframe_dcsc_id';
        newIframe.src = url;
        document.body.appendChild(newIframe);
        return newIframe;
    }


    function destroyIframe(iframeID) {
        let iframe = $('#' + iframeID).prop('contentWindow');

        $('#' + iframeID).attr('src', 'about:blank');

        try {
            iframe.document.write('');
            iframe.document.clear();
        } catch (e) {
        }
        $('#' + iframeID).remove();
    }


</script>

</html>