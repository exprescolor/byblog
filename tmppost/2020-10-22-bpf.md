---
layout:     post   				    # 使用的布局（不需要改）
title:     bpf学习笔记（1）	# 标题 
#subtitle:   脚本，xss #副标题
date:       2020-10-22 				# 时间
author:     s-seven 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
 
---

这段时间一直在看BPF，但是一直没有输出，这篇文章总结一下最近的学习内容。

# 概念原理

## BPF

BPF是Berkeley Packet Filter的缩写，作为一个包过滤器，提高了数据包捕获工具的性能。后来被纳入Linux内核，使得BPF成为一个通用的执行引擎，可以用于很多事情，包括创建高级性能分析工具。

BPF最开始是作为包过滤器被使用的，随着BPF的发展，人们开始使用它进行tracing的工作，因为它可以安全的获取内核的执行信息，是内核调试非常便利的工具。

BPF本身是一个基于栈的虚拟机，由指令集、存储对象和辅助函数组成。它可以被认为是一个虚拟机，因为它的虚拟指令集规范。这些指令由Linux内核BPF运行时执行，其中包括一个解释器和一个JIT编译器，用于将BPF指令转换为执行的本机指令。对于解释的和JIT编译的，BPF指令必须首先通过一个检查安全性的验证器，以确保BPF程序不会崩溃或损坏内核(然而，它不能阻止终端用户编写可能执行但没有意义的不合理程序)。

BPF本质上是一种内核代码注入技术：

- 内核中实现了一个cBPF/eBPF虚拟机；
- 用户态可以用C来写运行的代码，再通过一个Clang&LLVM的编译器将C代码编译成BPF目标码；
- 用户态通过系统调用bpf()将BPF目标码注入到内核当中；
- 内核通过JIT(Just-In-Time)将BPF目编码转换成本地指令码；如果当前架构不支持JIT转换内核则会使用一个解析器(interpreter)来模拟运行，这种运行效率较低；
- 内核在packet filter和tracing等应用中提供了一系列的钩子来运行BPF代码。

BPF的好处在哪里？ 是因为它提供了一种在不修改内核代码的情况下，可以灵活修改内核处理策略的方法。
这在包过滤和系统tracing这种需要频繁修改规则的场合非常有用。因为如果只在用户态修改策略的话那么所有数据需要复制一份给用户态开销较大；如果在内核态修改策略的话需要修改内核代码重新编译内核，而且容易引人安全问题。BPF这种内核代码注入技术的生存空间就是它可以在这两者间取得一个平衡。

## eBPF

经典的BPF 实现了一个register-based虚拟机, 根据用户态提供的规则, 可以用来抓取和过滤网络包. 不过BPF因为其指令集的原因, 不能够发挥现在处理器的能力, extented BPF (eBPF) 扩展了它的指令集, 并支持Just-In-Time (JIT), 性能上得到很大提高. (e)BPF能够在内核态执行用户提供的程序, 对于调试是非常有帮助的, 当然eBPF不只是用于调试. 同时eBPF虚拟机提供了一个安全的环境, 用户提供的程序经过严格检查, 只有通过检查的用户程序才能加载, 保证系统的稳定运行。

对于eBPF而言, 大概有如下几个执行步骤:
	• 编写ePBF伪机器代码
	• 调用bpf创建对应的map对象, 并将伪机器码加载到内核
	• 内核对加载得到伪机器码进行优化/校验, 验证其是否合法(是否有非法指令等)
	• 用户程序通过bpf的接口读取内核事件的结果


通过llvm, 我们只需要将需要执行的eBPF代码用C语言编写好后, 将其编译成elf格式的镜像(image)文件, 然后通过libelf库加载解析后, 装载到内核中执行。

在eBPF出现之前, Linux内核就已经支持ftrace, perf, kprobes, uprobes, tracepoints, user-level statically defined tracing (USDT)等等, 通过这些机制, 可以动态监视甚至修改系统的状态. 和systemtap一样, eBPF并没有重新实现这些机制, 只是attach eBPF的代码到这些events上面, 收集相应的信息. eBPF的主要贡献是提供了安全的环境来执行这些操作, 一个安全的环境是成熟解决方案的基础。

## bcc

bcc 是 bpf compiler collection, 一个不断丰富的基于ebpf的工具集合，bcc对linux内核的各个子系统（file、block、network、cpu、mem、security）都有一系列的工具支持。bcc基本上用python编写，通过bpf系统调用注入注入字节码给ebpf内核虚拟机。

BPF编译器集合(BCC，有时在项目和包名之后写成小写的bcc)是一个开源项目，其中包含用于构建BPF软件的编译器框架和库。它是BPF的主要前端项目，由BPF开发人员支持，通常是最新的内核跟踪BPF添加的第一次使用。

# BPF的开发过程

![在这里插入图片描述](https://img-blog.csdn.net/20180928153430803?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B3bDk5OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

# eBPF的数据交互：map



# bcc编程

